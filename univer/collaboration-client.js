(function(_,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("@univerjs/core"),require("@univerjs/sheets"),require("@univerjs/design"),require("@univerjs/ui"),require("@univerjs-pro/collaboration"),require("rxjs"),require("rxjs/operators"),require("@univerjs/docs"),require("@univerjs/network"),require("@univerjs/drawing"),require("@univerjs/engine-render"),require("@univerjs/engine-formula"),require("lodash/debounce"),require("@univerjs/sheets-ui"),require("react"),require("clsx"),require("@univerjs/rpc")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/sheets","@univerjs/design","@univerjs/ui","@univerjs-pro/collaboration","rxjs","rxjs/operators","@univerjs/docs","@univerjs/network","@univerjs/drawing","@univerjs/engine-render","@univerjs/engine-formula","lodash/debounce","@univerjs/sheets-ui","react","clsx","@univerjs/rpc"],o):(_=typeof globalThis<"u"?globalThis:_||self,o(_.UniverCollaborationClient={},_.UniverCore,_.UniverSheets,_.UniverDesign,_.UniverUi,_.UniverCollaboration,_.rxjs,_.rxjs.operators,_.UniverDocs,_.UniverNetwork,_.UniverDrawing,_.UniverEngineRender,_.UniverEngineFormula,_.lodash.debounce,_.UniverSheetsUi,_.React,_.clsx,_.UniverRpc))})(this,function(_,o,p,z,L,u,f,C,U,y,$,b,xe,be,J,N,At,Mt){"use strict";var Ji=Object.defineProperty;var Zi=(_,o,p)=>o in _?Ji(_,o,{enumerable:!0,configurable:!0,writable:!0,value:p}):_[o]=p;var d=(_,o,p)=>Zi(_,typeof o!="symbol"?o+"":o,p);const Ke="SNAPSHOT_SERVER_URL_KEY",Lt="/universer-api/snapshot",Xe="SNAPSHOT_URL_KEY",qe="SEND_CHANGESET_TIMEOUT",ze="COLLAB_WEB_SOCKET_URL",wt="ws://127.0.0.1:8000/universer-api/comb/connect",Je="HEARTBEAT_INTERVAL",Re="HEARTBEAT_TIMEOUT",$t="RETRY_CONNECTING_INTERVAL",jt="RETRY_CONNECTING_MAX_COUNT",Ze="LOCAL_CACHE_INTERVAL",Qe="COLLAB_SUBMIT_CHANGESET_URL",Ht="/universer-api/comb",kt="LOGIN_URL_KEY";var et=(n=>(n[n.UNDEFINED=0]="UNDEFINED",n[n.OK=1]="OK",n[n.INTERNAL_ERROR=2]="INTERNAL_ERROR",n[n.PERMISSION_DENIED=3]="PERMISSION_DENIED",n[n.NOT_FOUND=4]="NOT_FOUND",n[n.UNAUTHENTICATED=5]="UNAUTHENTICATED",n[n.ALREADY_EXISTS=6]="ALREADY_EXISTS",n[n.INVALID_ARGUMENT=7]="INVALID_ARGUMENT",n[n.TOO_MANY_REQUESTS=8]="TOO_MANY_REQUESTS",n[n.COMPLETION_FINISHED=9]="COMPLETION_FINISHED",n[n.CHANGESET_REVISION_CONFILICT=5001]="CHANGESET_REVISION_CONFILICT",n[n.SNAPSHOT_INVALID_SNAPSHOT=6001]="SNAPSHOT_INVALID_SNAPSHOT",n[n.SNAPSHOT_HAS_BEEN_REMOVED=6002]="SNAPSHOT_HAS_BEEN_REMOVED",n[n.APPLY_REJECT=7001]="APPLY_REJECT",n[n.APPLY_NON_SEQUENTIAL_REVISION=7002]="APPLY_NON_SEQUENTIAL_REVISION",n[n.APPLY_REVISION_CONFILICT=7003]="APPLY_REVISION_CONFILICT",n[n.APPLY_PERMISSION_DENIED=7004]="APPLY_PERMISSION_DENIED",n[n.CONNECTOR_DATA_TOO_LARGE=8001]="CONNECTOR_DATA_TOO_LARGE",n[n.LICENSE_MAX_UNITS_EXCEEDED=9001]="LICENSE_MAX_UNITS_EXCEEDED",n[n.LICENSE_MAX_MEMBERS_PER_UNIT_EXCEEDED=9002]="LICENSE_MAX_MEMBERS_PER_UNIT_EXCEEDED",n[n.LICENSE_IMPORT_SIZE_EXCEEDED=9003]="LICENSE_IMPORT_SIZE_EXCEEDED",n[n.LICENSE_EXPORT_SIZE_EXCEEDED=9004]="LICENSE_EXPORT_SIZE_EXCEEDED",n[n.LICENSE_DISTRO_REJECTED=9005]="LICENSE_DISTRO_REJECTED",n[n.YUUMI_UNABLE_LOAD_URL=10001]="YUUMI_UNABLE_LOAD_URL",n[n.YUUMI_URL_COL_OUT_OF_RANGE=10002]="YUUMI_URL_COL_OUT_OF_RANGE",n[n.YUUMI_RATE_OVER_LIMIT=10003]="YUUMI_RATE_OVER_LIMIT",n[n.YUUMI_SUBSCRIPTION_NOT_FOUND=10004]="YUUMI_SUBSCRIPTION_NOT_FOUND",n[n.UNRECOGNIZED=-1]="UNRECOGNIZED",n))(et||{}),j=(n=>(n[n.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",n[n.UNIVER_DOC=1]="UNIVER_DOC",n[n.UNIVER_SHEET=2]="UNIVER_SHEET",n[n.UNIVER_SLIDE=3]="UNIVER_SLIDE",n[n.UNRECOGNIZED=-1]="UNRECOGNIZED",n))(j||{}),R=(n=>(n[n.UNKNOWN_CMD=0]="UNKNOWN_CMD",n[n.HELLO=1]="HELLO",n[n.JOIN=2]="JOIN",n[n.LEAVE=3]="LEAVE",n[n.INGEST=4]="INGEST",n[n.HEARTBEAT=5]="HEARTBEAT",n[n.RECV=6]="RECV",n[n.UNRECOGNIZED=-1]="UNRECOGNIZED",n))(R||{}),Oe=(n=>(n[n.UNKNOWN_CODE=0]="UNKNOWN_CODE",n[n.OK=1]="OK",n[n.FAIL=2]="FAIL",n[n.UNRECOGNIZED=-1]="UNRECOGNIZED",n))(Oe||{}),Bt=Object.defineProperty,Ft=Object.getOwnPropertyDescriptor,Vt=(n,t,e,s)=>{for(var i=s>1?void 0:s?Ft(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Bt(t,e,i),i},tt=(n,t)=>(e,s)=>t(e,s,n);let G=class extends o.Disposable{constructor(t,e){super();d(this,"_roomMembers",new Map);this._univerInstanceService=t,this._userManagerService=e,this.disposeWithMe(o.toDisposable(f.merge(this._univerInstanceService.getTypeOfUnitDisposed$(o.UniverInstanceType.UNIVER_SHEET).pipe(C.map(s=>s.getUnitId())),this._univerInstanceService.getTypeOfUnitDisposed$(o.UniverInstanceType.UNIVER_DOC).pipe(C.map(s=>s.getUnitId())),this._univerInstanceService.getTypeOfUnitDisposed$(o.UniverInstanceType.UNIVER_SLIDE).pipe(C.map(s=>s.getUnitId()))).subscribe(s=>this._removeRoom(s))))}setCurrentUser(t){this._userManagerService.setCurrentUser(t)}getCurrentUser(){return this._userManagerService.getCurrentUser()}updateMember(t,e){let s=this._roomMembers.get(t);s||(s=new Wt,this._roomMembers.set(t,s)),s.updateMember(e)}removeMember(t,e){const s=this._roomMembers.get(t);s&&s.removeMember(e)}getRoom(t){return this._roomMembers.get(t)}getMember(t,e){const s=this._roomMembers.get(t);if(s)return s.getMember(e)}_removeRoom(t){const e=this._roomMembers.get(t);e&&(e.dispose(),this._roomMembers.delete(t))}dispose(){this._roomMembers.forEach(t=>t.dispose()),this._roomMembers.clear()}};G=Vt([tt(0,o.IUniverInstanceService),tt(1,o.Inject(o.UserManagerService))],G);class Wt extends o.Disposable{constructor(){super(...arguments);d(this,"_members",new Map)}dispose(){this._members.clear()}updateMember(e){this._members.set(e.memberID,e)}removeMember(e){this._members.delete(e)}getMember(e){return this._members.get(e)}}function st(n){var s,i,r,a;const t=n.data,e=JSON.parse(t);switch(e.cmd){case R.HEARTBEAT:case R.HELLO:{const c=e.infoRsp;return{...e,data:c,cmd:e.cmd}}case R.JOIN:{const c=e.joinRsp;return{...e,data:c,cmd:e.cmd}}case R.RECV:{const c=e.collaMsg;switch(c.eventID){case u.CollaborationEvent.PERMISSION_REJ:return{...e,data:{...c,data:(s=c.permissionRejEvent)==null?void 0:s.cs},cmd:e.cmd};case u.CollaborationEvent.CHANGESET_ACK:return{...e,data:{...c,data:(i=c.csAckEvent)==null?void 0:i.cs},cmd:e.cmd};case u.CollaborationEvent.NEW_CHANGESETS:return{...e,data:{...c,data:(r=c.newCsEvent)==null?void 0:r.cs},cmd:e.cmd};case u.CollaborationEvent.CHANGESET_REJ:return{...e,data:{...c,data:(a=c.csRejEvent)==null?void 0:a.cs},cmd:e.cmd};case u.CollaborationEvent.UPDATE_CURSOR:return{...e,data:{...c,data:c.updateCursorEvent},cmd:e.cmd};case u.CollaborationEvent.USERS_ENTER:return{...e,data:{...c,data:c.joinEvent},cmd:e.cmd};case u.CollaborationEvent.USERS_LEAVE:return{...e,data:{...c,data:c.leaveEvent},cmd:e.cmd};case u.CollaborationEvent.LIVESHARE_NEW_HOST:return{...e,data:{...c,data:c.liveShareNewHost},cmd:e.cmd};case u.CollaborationEvent.LIVESHARE_FETCH_OPERATIONS:case u.CollaborationEvent.LIVESHARE_OPERATION:return{...e,data:{...c,data:c.liveShareOperation},cmd:e.cmd};case u.CollaborationEvent.LIVESHARE_TERMINATE:return{...e,data:{...c,data:c.liveShareNewHost},cmd:e.cmd};case u.CollaborationEvent.MSG_FOR_ERROR:return{...e,data:c,cmd:e.cmd};case u.CollaborationEvent.COMMENT_UPDATE:return{...e,data:{...c,data:c.commentUpdateEvent},cmd:e.cmd};case u.CollaborationEvent.UPDATE_PERMISSION_OBJ:return{...e,data:{...c,data:c.updatePermissionObjEvent},cmd:e.cmd};case u.CollaborationEvent.SHOULD_CLOSE_CONN:return{...e,data:{...c,data:c.shouldCloseConn},cmd:e.cmd};default:return e}}default:return e}}function it(n){switch(n.cmd){case R.HEARTBEAT:case R.HELLO:return JSON.stringify({cmd:n.cmd,routeKey:n.routeKey});case R.INGEST:{let t;switch(n.data.eventID){case u.CollaborationEvent.UPDATE_CURSOR:{t={eventID:u.CollaborationEvent.UPDATE_CURSOR,updateCursorEvent:n.data.data};break}case u.CollaborationEvent.USERS_LEAVE:{t={eventID:u.CollaborationEvent.USERS_LEAVE,leaveEvent:n.data.data};break}case u.CollaborationEvent.USERS_ENTER:{t={eventID:u.CollaborationEvent.USERS_ENTER,joinEvent:n.data.data};break}case u.CollaborationEvent.LIVESHARE_NEW_HOST:{t={eventID:u.CollaborationEvent.LIVESHARE_NEW_HOST,liveShareNewHost:n.data.data};break}case u.CollaborationEvent.LIVESHARE_OPERATION:{t={eventID:u.CollaborationEvent.LIVESHARE_OPERATION,liveShareOperation:n.data.data};break}case u.CollaborationEvent.LIVESHARE_TERMINATE:{t={eventID:u.CollaborationEvent.LIVESHARE_TERMINATE,liveShareTerminate:n.data.data};break}case u.CollaborationEvent.LIVESHARE_REQUEST_HOST:{t={eventID:u.CollaborationEvent.LIVESHARE_REQUEST_HOST,liveShareRequestHost:n.data.data};break}case u.CollaborationEvent.LIVESHARE_FETCH_OPERATIONS:{t={eventID:u.CollaborationEvent.LIVESHARE_FETCH_OPERATIONS};break}default:t={eventID:n.data.eventID}}return JSON.stringify({cmd:n.cmd,routeKey:n.routeKey,collaMsg:t})}case R.JOIN:return JSON.stringify({cmd:n.cmd,routeKey:n.routeKey,joinReq:n.data});case R.LEAVE:return JSON.stringify({cmd:n.cmd,routeKey:n.routeKey,leaveReq:n.data});default:throw new Error("[serializeCombRequest]: should not fall into default branch!")}}var Gt=Object.defineProperty,Yt=Object.getOwnPropertyDescriptor,xt=(n,t,e,s)=>{for(var i=s>1?void 0:s?Yt(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Gt(t,e,i),i},te=(n,t)=>(e,s)=>t(e,s,n);const De=o.createIdentifier("univer-pro.collaboration-client-socket-service");function Kt(n,t,e){return`${n}/${t}/unit/${e}/new_changes`}_.CollaborationSocketService=class{constructor(t,e,s,i,r){this._http=t,this._ws=e,this._configService=s,this._logService=i,this._snapshotServerService=r}createSocket(t){const e=this._ws.createSocket(t);if(!e)throw new Error("[CollaborationSocketService]: failed to create socket!");const s=new o.DisposableCollection,i=new f.Subject;s.add(o.toDisposable(e.close$.subscribe(l=>i.next(l)))),s.add(o.toDisposable(()=>i.complete()));const r=new f.Subject;s.add(o.toDisposable(e.error$.subscribe(l=>r.next(l)))),s.add(o.toDisposable(()=>r.complete()));const a=new f.Subject;s.add(o.toDisposable(e.message$.subscribe(l=>{const S=st(l);a.next(S)}))),s.add(o.toDisposable(()=>a.complete()));const c=()=>{r.next(new Event("connection error")),i.next(new CloseEvent("connection error")),h.close()},h={memberID:"",close$:i.asObservable(),error$:r.asObservable(),open$:e.open$,message$:a.asObservable(),send:l=>{if(l.cmd===R.INGEST){if(l.data.eventID===u.CollaborationEvent.SUBMIT_CHANGESET){this._submitChangeset(h,l.data).catch(S=>{this._logService.error(S),c()});return}if(l.data.eventID===u.CollaborationEvent.FETCH_MISSING){const S=l.data;this._fetchMissChangesets(S).then(v=>{a.next({cmd:R.RECV,code:Oe.OK,routeKey:S.data.unitID,routeType:"",data:{eventID:u.CollaborationEvent.PSEUDO_FETCH_MISSING_RESULT,data:{changesets:v}}})}).catch(v=>{this._logService.error(v),c()});return}}e.send(it(l))},close:()=>{e.close(),s.dispose()}};return h}async _submitChangeset(t,e){var h;const{unitType:s,unitID:i,changeset:r}=e.data,a={unitID:i,memberID:t.memberID,type:s,changeset:u.parseChangesetToProtocol(r)},c=Kt((h=this._configService.getConfig(Qe))!=null?h:Ht,s,i);try{await this._http.post(c,{body:a})}catch(l){throw this._logService.error("[CollaborationSession]","submit changeset error!"),l}}async _fetchMissChangesets(t){const{unitID:e,from:s,to:i,unitType:r}=t.data;return(await this._snapshotServerService.fetchMissingChangesets({metadata:void 0},{unitID:e,type:r,from:s,to:i})).changesets}},_.CollaborationSocketService=xt([te(0,o.Inject(y.HTTPService)),te(1,o.Inject(y.WebSocketService)),te(2,o.IConfigService),te(3,o.ILogService),te(4,o.ISnapshotServerService)],_.CollaborationSocketService);class Ue{constructor(){d(this,"_commentUpdate$",new f.Subject);d(this,"commentUpdate$",this._commentUpdate$.asObservable())}onCommentUpdate(t){this._commentUpdate$.next(t)}}var Xt=Object.defineProperty,qt=Object.getOwnPropertyDescriptor,nt=(n,t,e,s)=>{for(var i=s>1?void 0:s?qt(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Xt(t,e,i),i},A=(n,t)=>(e,s)=>t(e,s,n),Y=(n=>(n[n.IDLE=0]="IDLE",n[n.JOINING=1]="JOINING",n[n.OFFLINE=2]="OFFLINE",n[n.ONLINE=3]="ONLINE",n))(Y||{});_.CollaborationSession=class extends o.RxDisposable{constructor(e,s,i,r,a,c,h,l,S){super();d(this,"_sessionStatus$",new f.BehaviorSubject(0));d(this,"sessionStatus$",this._sessionStatus$.asObservable());d(this,"_event$",new f.Subject);d(this,"event$",this._event$.asObservable());d(this,"_socket");d(this,"_socketMessageSubscription");d(this,"_collaborationTimeoutTimer");this._unitID=e,this._logService=i,this._beforeCloseService=r,this._messageService=a,this._configService=c,this._localeService=h,this._memberService=l,this._commentService=S,s.pipe(C.takeUntil(this.dispose$)).subscribe(v=>{var I;typeof v>"u"||(this._socket=v,v?(this._joinRoom(v),this._socketMessageSubscription=this._socket.message$.subscribe(g=>{g.routeKey===this._unitID&&this._onCombEvent(g)})):(this._sessionStatus$.next(2),(I=this._socketMessageSubscription)==null||I.unsubscribe(),this._socketMessageSubscription=null))}),this.disposeWithMe(this._beforeCloseService.registerOnClose(()=>{var v;(v=this._socket)==null||v.send({cmd:R.LEAVE,data:{roomID:this._unitID}})}))}get sessionStatus(){return this._sessionStatus$.getValue()}getMemberID(){var e,s;return(s=(e=this._socket)==null?void 0:e.memberID)!=null?s:null}dispose(){super.dispose(),this.dispose$.next(),this.dispose$.complete()}close(){var e,s;(e=this._socket)==null||e.send({cmd:R.LEAVE,data:{roomID:this._unitID}}),this._event$.complete(),this._sessionStatus$.complete(),(s=this._socket)==null||s.close(),this.dispose()}_onCombEvent(e){e.cmd===R.JOIN?this._onJoinRoomEvent(e):e.cmd===R.RECV&&this._onRecvEvent(e)}_joinRoom(e){this._sessionStatus$.next(1),e.send({cmd:R.JOIN,routeKey:this._unitID,routeType:"",data:{rooms:[{roomID:this._unitID}]}})}_onJoinRoomEvent(e){var i;if(e.code===Oe.FAIL){this._messageService.show({type:z.MessageType.Warning,content:this._localeService.t("session.room-full")}),this._sessionStatus$.next(2);return}this._sessionStatus$.next(3);const s=(i=e.data.roomInfos[this._unitID])==null?void 0:i.members;s&&s.forEach(r=>this._memberService.updateMember(this._unitID,r))}_onRecvEvent(e){try{const s=e.data;switch(s.eventID){case u.CollaborationEvent.USERS_ENTER:this._onUserJoin(s),this._event$.next(s);break;case u.CollaborationEvent.USERS_LEAVE:this._onUserLeave(s),this._event$.next(s);break;case u.CollaborationEvent.CHANGESET_ACK:this._clearCollaborationTimeoutTimer(),this._event$.next(s);break;case u.CollaborationEvent.MSG_FOR_ERROR:this._logService.error(`save fail reason is ${JSON.stringify(s)}`),this._event$.next(s);break;case u.CollaborationEvent.COMMENT_UPDATE:this._commentService.onCommentUpdate(s.data),this._event$.next(s);break;default:this._event$.next(s)}}catch(s){this._logService.error(s,e)}}_onUserJoin(e){this._memberService.updateMember(this._unitID,e.data)}_onUserLeave(e){this._memberService.removeMember(this._unitID,e.data.memberID)}async send(e,s){if(this.sessionStatus!==3||!this._socket)throw new Error("[CollaborationSession]: should not send message when the session is offline!");try{e.eventID===u.CollaborationEvent.NEW_CHANGESETS&&this._scheduleCollaborationTimeoutTimer(),this._socket.send({cmd:R.INGEST,routeKey:s,routeType:"",data:e})}catch(i){this._logService.error(i)}}_scheduleCollaborationTimeoutTimer(){var e;this._collaborationTimeoutTimer=window.setTimeout(()=>{this._collaborationTimeoutTimer=null,this._messageService.show({type:z.MessageType.Error,content:this._localeService.t("session.collaboration-timeout")})},(e=this._configService.getConfig(Re))!=null?e:1e4)}_clearCollaborationTimeoutTimer(){this._collaborationTimeoutTimer&&(clearTimeout(this._collaborationTimeoutTimer),this._collaborationTimeoutTimer=null)}},_.CollaborationSession=nt([A(2,o.ILogService),A(3,L.IBeforeCloseService),A(4,L.IMessageService),A(5,o.IConfigService),A(6,o.Inject(o.LocaleService)),A(7,o.Inject(G)),A(8,o.Inject(Ue))],_.CollaborationSession),_.CollaborationSessionService=class extends o.Disposable{constructor(e,s,i,r,a,c){super();d(this,"_socket$",new f.BehaviorSubject(void 0));d(this,"_sessions",new Map);d(this,"_status$",new f.BehaviorSubject(0));d(this,"status$",this._status$.asObservable());d(this,"_socketReady",!1);d(this,"_sendHeartbeatTimer");d(this,"_timeoutTimer");d(this,"_retryConnectingTimer");d(this,"_retryCount",0);this._injector=e,this._localeService=s,this._messageService=i,this._logService=r,this._configService=a,this._socketService=c}get _socket(){return this._socket$.getValue()}dispose(){super.dispose(),this._sessions.forEach(e=>e.dispose()),this._sessions.clear(),this._status$.complete()}async requireSession(e){if(this._sessions.has(e))return this._sessions.get(e);this._tryEnsureSocket();const s=this._injector.createInstance(_.CollaborationSession,e,this._socket$.asObservable());return this._sessions.set(e,s),s}closeSession(e){var i;const s=this._sessions.get(e);s&&(this._sessions.delete(e),s.close()),this._sessions.size||(i=this._socket)==null||i.close()}_createSocket(){var i;const e=(i=this._configService.getConfig(ze))!=null?i:wt;return this._socketService.createSocket(e)}_tryEnsureSocket(){try{const e=this._createSocket();if(e){const s=e.send;e.send=i=>(this._rescheduleHeartbeatEvent(),s.apply(e,[i])),e.message$.subscribe(i=>this._onMessage(e,i)),e.error$.pipe(C.take(1)).subscribe(i=>this._logService.error("[CollaborationSessionService]: socket error",i)),e.open$.pipe(C.take(1)).subscribe(()=>{this._onConnectionOpen(e)}),e.close$.pipe(C.take(1)).subscribe(i=>{this._logService.debug("[CollaborationSessionService]","socket close",i),this._onConnectionFailed()})}}catch(e){this._logService.error(e),this._onConnectionFailed()}}_onConnectionOpen(e){this._logService.debug("[CollaborationSessionService]","socket open."),e.send({cmd:R.HELLO}),this._rescheduleHeartbeatEvent()}_onConnectionFailed(){var e;this._status$.next(2),this._socket$.next(null),this._clearTimeoutTimer(),this._clearHeartbeatTimer(),this._socketReady=!1,this._retryCount<((e=this._configService.getConfig(jt))!=null?e:3)?(this._scheduleReconnection(this._retryCount),this._retryCount+=1):this._messageService.show({type:z.MessageType.Error,content:this._localeService.t("session.connection-failed")})}_scheduleReconnection(e){var i;const s=((i=this._configService.getConfig($t))!=null?i:2e4)*2**e;this._messageService.show({type:z.MessageType.Warning,content:this._localeService.t("session.will-retry")}),this._retryConnectingTimer=setTimeout(()=>{this._tryEnsureSocket(),clearTimeout(this._retryConnectingTimer),this._retryConnectingTimer=null},s)}_rescheduleHeartbeatEvent(){var e;this._clearHeartbeatTimer(),this._sendHeartbeatTimer=setTimeout(()=>this._sendHeartbeat(),(e=this._configService.getConfig(Je))!=null?e:3e4)}_sendHeartbeat(){this._socket.send({cmd:R.HEARTBEAT}),this._waitForHeartbeatResponse()}_waitForHeartbeatResponse(){var e;this._timeoutTimer=setTimeout(()=>this._onConnectionFailed(),(e=this._configService.getConfig(Re))!=null?e:1e4)}_onMessage(e,s){const{cmd:i}=s;i===R.HELLO&&!this._socketReady&&(e.memberID=s.data.memberID,this._socket$.next(e),this._status$.next(3),this._socketReady=!0),i===R.HEARTBEAT&&this._clearTimeoutTimer(),this._rescheduleHeartbeatEvent()}_clearHeartbeatTimer(){this._sendHeartbeatTimer!=null&&(clearTimeout(this._sendHeartbeatTimer),this._sendHeartbeatTimer=null)}_clearTimeoutTimer(){this._timeoutTimer!=null&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null)}},_.CollaborationSessionService=nt([A(0,o.Inject(o.Injector)),A(1,o.Inject(o.LocaleService)),A(2,L.IMessageService),A(3,o.ILogService),A(4,o.IConfigService),A(5,De)],_.CollaborationSessionService);var zt=Object.defineProperty,Jt=Object.getOwnPropertyDescriptor,Zt=(n,t,e,s)=>{for(var i=s>1?void 0:s?Jt(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&zt(t,e,i),i},se=(n,t)=>(e,s)=>t(e,s,n);_.LocalCacheService=class extends o.Disposable{constructor(e,s,i,r,a){super();d(this,"_cachedData",new Map);d(this,"_saveTaskMap",new Map);d(this,"_disabled",!1);this._configService=e,this._localStorageService=s,this._beforeCloseService=i,this._localeService=r,this._revisionService=a,this._setupBeforeClosingHandler()}disableLocalCache(){this._disabled=!0}enableLocalCache(){this._disabled=!1}dispose(){this.exhaustSavingTask().then(()=>super.dispose())}async loadOfflineData(e){return this._disabled?null:this._localStorageService.getItem(rt(e))}async saveOfflineData(e,s){return!!this._localStorageService.setItem(e,s)}updateOfflineData(e,s,i,r){const a=this._revisionService.getCurrentRevForDocument(e);this._cachedData.set(e,{unitID:e,type:s,awaitingChangeset:i,mutations:r,rev:a}),this._saveTaskMap.has(e)||this._scheduleSaving(e)}_scheduleSaving(e){const s=this._getSaveTimeout();s===0?this._saveCache(e):this._saveTaskMap.set(e,setTimeout(()=>this._saveCache(e),s))}_getSaveTimeout(){var e;return(e=this._configService.getConfig(Ze))!=null?e:1e3}_saveCache(e){const s=this._saveTaskMap.get(e);return s!==void 0&&window.clearTimeout(s),this._localStorageService.setItem(rt(e),this._cachedData.get(e)).then(()=>this._saveTaskMap.delete(e))}async exhaustSavingTask(){const e=[];this._saveTaskMap.forEach((s,i)=>{window.clearTimeout(s),e.push(this._saveCache(i).then(()=>{this._saveTaskMap.delete(i)}))}),await Promise.all(e)}_setupBeforeClosingHandler(){this.disposeWithMe(this._beforeCloseService.registerBeforeClose(()=>{if(this._saveTaskMap.size)return this._localeService.t("collaboration-client.offline-data-not-saved")}))}},_.LocalCacheService=Zt([se(0,o.IConfigService),se(1,o.ILocalStorageService),se(2,L.IBeforeCloseService),se(3,o.Inject(o.LocaleService)),se(4,o.Inject(u.RevisionService))],_.LocalCacheService);function rt(n){return`unit-cache-${n}`}const _e=o.createIdentifier("univer-pro.collaboration-client.single-active-unit-service");var ot=(n=>(n[n.NO_OTHER_CLIENTS_EDITING=0]="NO_OTHER_CLIENTS_EDITING",n[n.OTHER_CLIENTS_EDITING=1]="OTHER_CLIENTS_EDITING",n))(ot||{});const at=3e4,ct="ACTIVE_UNIT_EVENT_CHANNEL";class Qt extends o.Disposable{constructor(){super();d(this,"_id",o.Tools.generateRandomId());d(this,"_selfUnitIDs",new Set);d(this,"_unitOnClients",new Map);d(this,"_heartbeatTimer",null);d(this,"_clearOtherTimers",new Map);d(this,"_unitStatus",new Map);this._init()}dispose(){super.dispose(),this._clearOtherTimers.forEach((e,s)=>this._removeClearOtherTimer(s)),this._heartbeatTimer&&window.clearInterval(this._heartbeatTimer)}getUnitStatus$(e){return this._ensureSubject(e).pipe(f.distinctUntilChanged())}editingUnit(e){this._selfUnitIDs.size===0&&this._scheduleHeartbeat(),this._selfUnitIDs.add(e),this._send({type:0,memberID:this._id,unitIDs:[e],isForwarded:!1})}disposeUnit(e){this._selfUnitIDs.delete(e),this._selfUnitIDs.size===0&&this._heartbeatTimer&&window.clearInterval(this._heartbeatTimer)}_init(){this.disposeWithMe(o.toDisposable(f.fromEvent(window,"storage").subscribe(e=>{if(e.key!==ct||!e.newValue)return;const s=JSON.parse(e.newValue);this._handleEvent(s)}))),window.addEventListener("unload",()=>this._send({type:1,memberID:this._id,unitIDs:Array.from(this._selfUnitIDs)}))}_handleEvent(e){switch(e.type){case 0:this._handleJoinEvent(e);break;case 1:this._handleLeaveEvent(e);break;case 2:this._handleHeartbeatEvent(e);break}}_handleJoinEvent(e){const{unitIDs:s,memberID:i,isForwarded:r}=e;s.forEach(a=>{if(!r&&this._unitOnClients.has(a)&&this._ensureSubject(a).next(1),!this._unitOnClients.has(a)||!this._unitOnClients.get(a).has(i)){const c=this._unitOnClients.get(a)||new Set;c.add(i),this._unitOnClients.set(a,c),this._scheduleClearOtherTimer(i)}}),r||this._send({type:0,memberID:this._id,unitIDs:[...this._selfUnitIDs],isForwarded:!0})}_scheduleClearOtherTimer(e){this._removeClearOtherTimer(e);const s=window.setTimeout(()=>{this._unitOnClients.forEach(i=>{i.delete(e)})},at*2);this._clearOtherTimers.set(e,s)}_removeClearOtherTimer(e){if(this._clearOtherTimers.has(e)){const s=this._clearOtherTimers.get(e);s&&window.clearTimeout(s),this._clearOtherTimers.set(e,null)}}_handleLeaveEvent(e){const{memberID:s,unitIDs:i}=e;i.forEach(r=>{var c;const a=this._unitOnClients.get(r);a&&(a.delete(s),(c=this._ensureSubject(r))==null||c.next(a.size===0?0:1))}),this._removeClearOtherTimer(s)}_handleHeartbeatEvent(e){this._scheduleClearOtherTimer(e.memberID)}_send(e){localStorage.setItem(ct,JSON.stringify(e))}_scheduleHeartbeat(){this._heartbeatTimer=window.setInterval(()=>{this._send({type:2,memberID:this._id})},at)}_ensureSubject(e){return this._unitStatus.has(e)||this._unitStatus.set(e,new f.BehaviorSubject(0)),this._unitStatus.get(e)}}var es=Object.defineProperty,ts=Object.getOwnPropertyDescriptor,ss=(n,t,e,s)=>{for(var i=s>1?void 0:s?ts(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&es(t,e,i),i},ht=(n,t)=>(e,s)=>t(e,s,n);let ue=class{constructor(n,t){this._injector=n,this._transformService=t}transformIMECache(n){this._transformUndoRedoStack(n),this._transformPreviousActiveRange(n)}transformRemoteChangeset(n){const t=this._injector.get(U.IMEInputManagerService),{redoCache:e}=t.getUndoRedoMutationParamsCache();if(e.length===0)return n;let s=o.Tools.deepClone(n.mutations[0]);for(let i=0;i<e.length;i++){const r={id:"doc.mutation.rich-text-editing",params:{...e[i]}},a=this._transformService.transformMutation(s,r,!1);if(u.isTransformMutationFailure(a))throw a.error;s=a.m1Prime}return{...o.Tools.deepClone(n),mutations:[s]}}_transformUndoRedoStack(n){const t=this._injector.get(U.IMEInputManagerService),{undoCache:e,redoCache:s}=t.getUndoRedoMutationParamsCache();if(e.length===0||s.length===0)return;const i=[],r=[];let a=o.Tools.deepClone(n.mutations[0]),c=o.Tools.deepClone(n.mutations[0]);for(let h=e.length-1;h>=0;h--){const l={id:"doc.mutation.rich-text-editing",params:{...e[h]}},S={id:"doc.mutation.rich-text-editing",params:{...s[h]}},v=this._transformService.transformMutation(a,l,!1),I=this._transformService.transformMutation(c,S,!1);if(u.isTransformMutationFailure(v))throw v.error;if(u.isTransformMutationFailure(I))throw I.error;i.unshift(v.m2Prime.params),r.unshift(I.m2Prime.params),a=v.m1Prime,c=I.m1Prime}t.setUndoRedoMutationParamsCache({undoCache:i,redoCache:r})}_transformPreviousActiveRange(n){const t=this._injector.get(U.IMEInputManagerService),e=t.getActiveRange();if(e==null)return;const s=[{id:"doc.mutation.rich-text-editing",params:{unitId:n.unitID,actions:null,textRanges:[e]}}],i=this._transformService.transformMutationsWithChangeset(n,s);if(!u.isTransformMutationsWithChangesetSuccess(i))throw i.error;const r=i.m2Prime[0].params.textRanges;Array.isArray(r)&&r.length&&t.setActiveRange(r[0])}};ue=ss([ht(0,o.Inject(o.Injector)),ht(1,u.ITransformService)],ue);var is=Object.defineProperty,ns=Object.getOwnPropertyDescriptor,rs=(n,t,e,s)=>{for(var i=s>1?void 0:s?ns(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&is(t,e,i),i},lt=(n,t)=>(e,s)=>t(e,s,n);let de=class{constructor(n,t){this._injector=n,this._transformService=t}transformSelections(n){var c;const t=this._injector.get(U.TextSelectionManagerService),e=(c=t.getDocRanges())!=null?c:[],s=e==null?void 0:e.map(U.serializeDocRange);if(s.length===0)return;const i=[{id:"doc.mutation.rich-text-editing",params:{unitId:n.unitID,actions:null,textRanges:s}}],r=this._transformService.transformMutationsWithChangeset(n,i);if(!u.isTransformMutationsWithChangesetSuccess(r))throw r.error;const a=r.m2Prime[0].params.textRanges;Array.isArray(a)&&a.length&&t.replaceTextRanges(a,!1)}};de=rs([lt(0,o.Inject(o.Injector)),lt(1,u.ITransformService)],de);function _t(n){let t="";for(const e of n){const{startOffset:s,endOffset:i,isActive:r}=e;t.length&&(t+=","),t+=`${s}:${i}:${r?"1":"0"}`}return t}function os(n){const t=n.split(","),e=[];for(const s of t){const[i,r,a]=s.split(":");e.push({startOffset:Number(i),endOffset:Number(r),collapsed:i===r,isActive:a==="1"})}return e.some(s=>s.isActive)||(e[0].isActive=!0),e}class Pe extends o.RxDisposable{constructor(){super(...arguments);d(this,"_collabCursorState$",new f.BehaviorSubject(null));d(this,"collabCursorState$",this._collabCursorState$.asObservable())}syncEditingCollabCursor(e){const{unitID:s,memberID:i,textRanges:r}=e,a=_t(r),c={unitID:s,memberID:i,selection:a};this._collabCursorState$.next(c)}}var as=Object.defineProperty,cs=Object.getOwnPropertyDescriptor,hs=(n,t,e,s)=>{for(var i=s>1?void 0:s?cs(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&as(t,e,i),i},ut=(n,t)=>(e,s)=>t(e,s,n);function ls(n){const{unitID:t,mutations:e}=n;return{unitId:t,subUnitId:e[0].params.subUnitId}}let Se=class{constructor(n,t){this._injector=n,this._transformService=t}transformSelections(n){var h,l,S;const t=this._injector.get(p.SheetsSelectionsService),{unitId:e,subUnitId:s}=ls(n),i=t.getWorkbookSelections(e).getCurrentSelections();if(i.length===0||!e||!s)return;const r=[{id:p.SetSelectionsOperation.id,params:{unitId:e,subUnitId:s,selections:o.Tools.deepClone(i)}}],a=this._transformService.transformMutationsWithChangeset(n,r);if(!u.isTransformMutationsWithChangesetSuccess(a))throw a.error;const c=(S=(l=(h=a.m2Prime[0])==null?void 0:h.params)==null?void 0:l.selections)!=null?S:i;Array.isArray(c)&&c.length&&this._injector.get(o.ICommandService).executeCommand(p.SetSelectionsOperation.id,{unitId:e,subUnitId:s,selections:c})}};Se=hs([ut(0,o.Inject(o.Injector)),ut(1,u.ITransformService)],Se);const _s=new Set([p.InsertSheetMutation.id]);function dt(n,t,e,s,i){var l,S,v,I;const r=[];for(const g of n)if(_s.has(g.id)){if(r.length>0)break;r.push(g);break}else r.push(g);const a=(S=(l=i.getCurrentUser())==null?void 0:l.userID)!=null?S:"unknown",c=(I=(v=i.getCurrentUser())==null?void 0:v.memberID)!=null?I:"unknown";return{changeset:{unitID:t,type:u.mapDocumentTypeToUniverType(e.getUnitType(t)),baseRev:s.getCurrentRevForDocument(t),revision:0,userID:a,memberID:c,mutations:r},pendingMutations:n.slice(r.length)}}function us(n,t,e,s,i){var S,v,I,g;const a=[n.reduce((T,D)=>{var le;const{id:O}=T,{id:M,type:q}=D,Ge=(le=T.params)!=null?le:{actions:null},he=D.params;if(O&&O!==M)throw new Error(`Cannot assemble a changeset from multiple mutations of different types: ${O} - ${M}.`);return{...T,id:M,type:q,params:{unitId:he.unitId,textRanges:he.textRanges,actions:o.JSONX.compose(Ge.actions,he.actions)}}},{})],c=(v=(S=i.getCurrentUser())==null?void 0:S.userID)!=null?v:"unknown",h=(g=(I=i.getCurrentUser())==null?void 0:I.memberID)!=null?g:"unknown";return{changeset:{unitID:t,type:u.mapDocumentTypeToUniverType(e.getUnitType(t)),baseRev:s.getCurrentRevForDocument(t),revision:0,userID:c,memberID:h,mutations:a},pendingMutations:[]}}const ds={id:p.EmptyMutation.id,type:o.CommandType.MUTATION,params:{}};var Ss=Object.defineProperty,vs=Object.getOwnPropertyDescriptor,x=(n,t,e,s)=>{for(var i=s>1?void 0:s?vs(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Ss(t,e,i),i},m=(n,t)=>(e,s)=>t(e,s,n),P=(n=>(n.NOT_COLLAB="not_collab",n.SYNCED="synced",n.PENDING="pending",n.AWAITING="awaiting",n.AWAITING_WITH_PENDING="awaiting_with_pending",n.FETCH_MISS="fetch_missing",n.CONFLICT="conflict",n.OFFLINE="offline",n))(P||{});class K{constructor(t,e,s,i,r,a,c,h,l){d(this,"_awaitingChangeset",null);d(this,"_pendingMutations",[]);this.unitID=t,this.type=e,this._handler=r,this._commandService=a,this._undoRedoService=c,this._revisionService=h,this._localCacheService=l,this._awaitingChangeset=s,this._pendingMutations=i}_checkMissing(t){const e=this._revisionService.getCurrentRevForDocument(this.unitID);return t.revision>e+1?(this._handler.onMissingChangesets({from:e,to:t.revision-1}),!0):!1}_transformUndoredo(t){this._undoRedoService.transformUndoRedo(this.unitID,t)}_transformSelections(t){var e,s;(s=(e=this._handler).onTransformSelections)==null||s.call(e,t)}_transformIMECache(t){var e,s;return(s=(e=this._handler).onTransformIME)==null?void 0:s.call(e,t)}_transformRemoteChangesetByIMECache(t){var e,s,i;return(i=(s=(e=this._handler).onTransformRemoteChangesetByIMECache)==null?void 0:s.call(e,t))!=null?i:t}_syncEditingCollabCursor(t){var e,s;if(this.type===j.UNIVER_DOC){const{unitID:i,mutations:r,memberID:a}=t,c=r[0].params.textRanges;Array.isArray(c)&&c.length>0&&((s=(e=this._handler).onSyncEditingCollabCursor)==null||s.call(e,{unitID:i,memberID:a,textRanges:c}))}}_updateLocalCache(){this._localCacheService.updateOfflineData(this.unitID,this.type,this._awaitingChangeset,this._pendingMutations)}_getCurrentRevision(){return this._revisionService.getCurrentRevForDocument(this.unitID)}_incrementRevisionNumber(){this._revisionService.incrementRevForDocument(this.unitID)}_executeRemoteChangeset(t){var i;const e=this._transformRemoteChangesetByIMECache(t),s=o.sequenceExecute(e.mutations,this._commandService,{fromCollab:!0});if(!s.result)throw s.error instanceof Error?s.error:new Error((i=s.error)!=null?i:"[CollaborationState]: apply error!");this._transformIMECache(e),this._transformUndoredo(t),this._transformSelections(e),this._syncEditingCollabCursor(e),this._incrementRevisionNumber()}}let ie=class extends K{constructor(t,e,s,i,r,a,c,h,l,S){super(t,e,null,[],s,h,c,i,r);d(this,"status","synced");this._injector=a,this._logService=l,this._transformService=S}appendMutation(t){const e=this._injector.createInstance(H,this.unitID,this.type,[t],this._handler);return e._schedule(),e._updateLocalCache(),e}onRemoteChangeset(t){if(this._checkMissing(t))return this._injector.createInstance(B,this.unitID,this.type,null,[],null,[t],this._handler);try{const s=this._transformService.transformMutationsWithChangeset(t,[ds]);if(u.isTransformMutationsWithChangesetSuccess(s)){const{c1Prime:i}=s;return this._executeRemoteChangeset(i),this}throw s.error}catch(s){return this._logService.error(s),this._onConflict(!1)}}_onConflict(t){return this._injector.createInstance(V,this.unitID,this.type,null,[],this._handler,t)}onRemoteAck(){throw new Error("[SyncedState]: received acknowledgement.")}onRemoteRej(){throw new Error("[SyncedState]: received rejection.")}toggleOffline(){return this._injector.createInstance(W,this.unitID,this.type,null,[],this._handler)}toggleOnline(){return this}resend(){throw new Error("[SyncedState]: invalid calling to `resend`.")}};ie=x([m(3,o.Inject(u.RevisionService)),m(4,o.Inject(_.LocalCacheService)),m(5,o.Inject(o.Injector)),m(6,o.IUndoRedoService),m(7,o.ICommandService),m(8,o.ILogService),m(9,u.ITransformService)],ie);let H=class extends K{constructor(t,e,s,i,r,a,c,h,l,S,v,I,g,T){super(t,e,null,s,i,S,T,a,c);d(this,"status","pending");d(this,"_scheduleTimestamp",null);d(this,"_sendingTimer",null);this._injector=r,this._memberService=h,this._logService=l,this._configService=v,this._transformService=I,this._univerInstanceService=g}appendMutation(t){return this._pendingMutations.push(t),this._updateLocalCache(),this}onRemoteChangeset(t){if(this._checkMissing(t))return this._clearScheduledTask(),this._injector.createInstance(B,this.unitID,this.type,null,this._pendingMutations,null,[t],this._handler);try{const s=this._transformService.transformMutationsWithChangeset(t,this._pendingMutations);if(u.isTransformMutationsWithChangesetSuccess(s)){const{c1Prime:i,m2Prime:r}=s;this._executeRemoteChangeset(i);const a=this._injector.createInstance(H,this.unitID,this.type,r,this._handler);return this._clearScheduledTask(),a._schedule(this._scheduleTimestamp?Math.max(0,new Date().getTime()-this._scheduleTimestamp):this._getSendChangesetTimeout()),a}throw s.error}catch(s){return this._logService.error(s),this._onConflict(!1)}}onRemoteAck(){throw new Error("[PendingState]: received acknowledgement.")}onRemoteRej(){throw new Error("[PendingState]: received rejection.")}toggleOffline(){return this._clearScheduledTask(),this._injector.createInstance(W,this.unitID,this.type,null,this._pendingMutations,this._handler)}toggleOnline(){return this}_schedule(t){t=t!=null?t:this._getSendChangesetTimeout(),this._scheduleTimestamp=new Date().getTime(),this._sendingTimer=setTimeout(()=>{this._clearScheduledTask();let e=null;switch(this.type){case j.UNIVER_SHEET:{e=dt(this._pendingMutations,this.unitID,this._univerInstanceService,this._revisionService,this._memberService);break}case j.UNIVER_DOC:{this._pendingMutations.every(a=>a.id===U.RichTextEditingMutation.id)?e=us(this._pendingMutations,this.unitID,this._univerInstanceService,this._revisionService,this._memberService):e=dt(this._pendingMutations,this.unitID,this._univerInstanceService,this._revisionService,this._memberService);break}default:throw new Error(`[PendingState]: unhandled univer type: ${this.type} in _schedule.`)}const{changeset:s,pendingMutations:i}=e;this._handler.onSendChangeset(s);const r=i.length?this._injector.createInstance(k,this.unitID,this.type,s,i,this._handler):this._injector.createInstance(F,this.unitID,this.type,s,this._handler);r._updateLocalCache(),this._handler.onStateChange(this,r)},t)}_getSendChangesetTimeout(){var t;return(t=this._configService.getConfig(qe))!=null?t:2e3}resend(){throw new Error("[PendingState]: invalid calling to `resend`.")}_clearScheduledTask(){this._sendingTimer!=null&&(clearTimeout(this._sendingTimer),this._sendingTimer=null)}_onConflict(t){return this._clearScheduledTask(),this._injector.createInstance(V,this.unitID,this.type,null,this._pendingMutations,this._handler,t)}};H=x([m(4,o.Inject(o.Injector)),m(5,o.Inject(u.RevisionService)),m(6,o.Inject(_.LocalCacheService)),m(7,o.Inject(G)),m(8,o.ILogService),m(9,o.ICommandService),m(10,o.IConfigService),m(11,u.ITransformService),m(12,o.IUniverInstanceService),m(13,o.IUndoRedoService)],H);let F=class extends K{constructor(t,e,s,i,r,a,c,h,l,S,v){super(t,e,s,[],i,h,v,a,c);d(this,"status","awaiting");this._injector=r,this._logService=l,this._transformService=S}appendMutation(t){const e=this._injector.createInstance(k,this.unitID,this.type,this._awaitingChangeset,[t],this._handler);return e._updateLocalCache(),e}onRemoteChangeset(t){if(this._checkMissing(t))return this._injector.createInstance(B,this.unitID,this.type,this._awaitingChangeset,[],null,[t],this._handler);try{const s=this._transformService.transformChangesets([t],[this._awaitingChangeset],!1);if(u.isTransformChangesetsSuccess(s)){const{c1Prime:i,c2Prime:r}=s;this._executeRemoteChangeset(i[0]),r[0].baseRev=this._getCurrentRevision();const a=this._injector.createInstance(F,this.unitID,this.type,r[0],this._handler);return a._updateLocalCache(),a}return this._onConflict(!1)}catch(s){return this._logService.error(s),this._onConflict(!1)}}onRemoteAck(t){const e=this._revisionService.getCurrentRevForDocument(this.unitID);if(t.revision<e-1)return this;if(this._checkMissing(t))return this._injector.createInstance(B,this.unitID,this.type,null,[],this._awaitingChangeset,[],this._handler);this._incrementRevisionNumber();const i=this._injector.createInstance(ie,this.unitID,this.type,this._handler);return i._updateLocalCache(),i}onRemoteRej(t){return this._onConflict(!!(t!=null&&t.isPermissionRej))}toggleOffline(){return this._injector.createInstance(W,this.unitID,this.type,this._awaitingChangeset,[],this._handler)}toggleOnline(){return this}resend(){this._handler.onSendChangeset(this._awaitingChangeset)}_onConflict(t){return this._injector.createInstance(V,this.unitID,this.type,this._awaitingChangeset,[],this._handler,t)}};F=x([m(4,o.Inject(o.Injector)),m(5,o.Inject(u.RevisionService)),m(6,o.Inject(_.LocalCacheService)),m(7,o.ICommandService),m(8,o.ILogService),m(9,u.ITransformService),m(10,o.IUndoRedoService)],F);let k=class extends K{constructor(t,e,s,i,r,a,c,h,l,S,v,I){super(t,e,s,i,r,l,I,c,h);d(this,"status","awaiting_with_pending");this._injector=a,this._logService=S,this._transformService=v}appendMutation(t){return this._pendingMutations.push(t),this}onRemoteChangeset(t){if(this._checkMissing(t))return this._injector.createInstance(B,this.unitID,this.type,this._awaitingChangeset,this._pendingMutations,null,[t],this._handler);try{const s=this._transformService.transformChangesets([t],[this._awaitingChangeset],!1);if(u.isTransformChangesetsSuccess(s)){const{c1Prime:i,c2Prime:r}=s,a=this._transformService.transformMutationsWithChangeset(i[0],this._pendingMutations);if(u.isTransformMutationsWithChangesetSuccess(a)){const{c1Prime:c,m2Prime:h}=a;return this._executeRemoteChangeset(c),r[0].baseRev=this._getCurrentRevision(),this._injector.createInstance(k,this.unitID,this.type,r[0],h,this._handler)}throw a.error}throw s.error}catch(s){return this._logService.error(s),this._onConflict(!1)}}onRemoteAck(t){if(this._checkMissing(t))return this._injector.createInstance(B,this.unitID,this.type,null,this._pendingMutations,this._awaitingChangeset,[],this._handler);this._incrementRevisionNumber();const s=this._injector.createInstance(H,this.unitID,this.type,this._pendingMutations,this._handler);return s._schedule(),s._updateLocalCache(),s}onRemoteRej(t){return this._onConflict(!!(t!=null&&t.isPermissionRej))}toggleOffline(){return this._injector.createInstance(W,this.unitID,this.type,this._awaitingChangeset,this._pendingMutations,this._handler)}toggleOnline(){return this}resend(){this._handler.onSendChangeset(this._awaitingChangeset)}_onConflict(t){return this._injector.createInstance(V,this.unitID,this.type,null,this._pendingMutations,this._handler,t)}};k=x([m(5,o.Inject(o.Injector)),m(6,o.Inject(u.RevisionService)),m(7,o.Inject(_.LocalCacheService)),m(8,o.ICommandService),m(9,o.ILogService),m(10,u.ITransformService),m(11,o.IUndoRedoService)],k);let V=class extends K{constructor(t,e,s,i,r,a=!1,c,h,l,S,v,I,g){super(t,e,s,i,r,h,l,v,S);d(this,"status","conflict");this._isPermissionRej=a,this._permissionService=c,this._localeService=I,this._notificationService=g,this._showConflictNotification(),this._clearLocalCache(),this._disableEditing()}appendMutation(){return this}onRemoteChangeset(){return this}onRemoteAck(){return this}onRemoteRej(){return this}toggleOffline(){return this}toggleOnline(){return this}resend(){throw new Error("[ConflictState]: invalid calling to `resend`.")}_clearLocalCache(){this._localCacheService.updateOfflineData(this.unitID,this.type,null,[])}_showConflictNotification(){this._isPermissionRej?this._notificationService.show({title:this._localeService.t("permission.title"),content:this._localeService.t("permission.content"),type:"error",duration:0}):this._notificationService.show({title:this._localeService.t("conflict.title"),content:this._localeService.t("conflict.content"),type:"error",duration:0})}_disableEditing(){this._permissionService.updatePermissionPoint(new p.WorkbookEditablePermission(this.unitID).id,!1)}};V=x([m(6,o.Inject(o.IPermissionService)),m(7,o.ICommandService),m(8,o.IUndoRedoService),m(9,o.Inject(_.LocalCacheService)),m(10,o.Inject(u.RevisionService)),m(11,o.Inject(o.LocaleService)),m(12,L.INotificationService)],V);let W=class extends K{constructor(t,e,s,i,r,a,c,h,l,S){super(t,e,s,i,r,l,S,c,h);d(this,"status","offline");this._injector=a}appendMutation(t){return this._pendingMutations.push(t),this._updateLocalCache(),this}onRemoteChangeset(t){throw new Error("[OfflineState]: received changeset.")}onRemoteAck(){throw new Error("[OfflineState]: received acknowledgement.")}onRemoteRej(){throw new Error("[OfflineState]: received rejection.")}toggleOffline(){return this}toggleOnline(){const{_injector:t,_pendingMutations:e,_awaitingChangeset:s,unitID:i,_handler:r,type:a}=this,c=St(t,i,a,s,e,r);return c instanceof H?c._schedule():(c instanceof k||c instanceof F)&&c.resend(),c}resend(){throw new Error("[OfflineState]: invalid calling to `resend`.")}};W=x([m(5,o.Inject(o.Injector)),m(6,o.Inject(u.RevisionService)),m(7,o.Inject(_.LocalCacheService)),m(8,o.ICommandService),m(9,o.IUndoRedoService)],W);let B=class extends K{constructor(t,e,s,i,r,a,c,h,l,S,v,I,g,T){super(t,e,s,i,c,I,g,l,S);d(this,"status","fetch_missing");this._acknowledgedAwaitingChangeset=r,this._queuedRemoteChangesets=a,this._injector=h,this._logService=v,this._transformService=T}onMissedChangesetFetched(t){try{const e=[...t,...this._queuedRemoteChangesets],s=[this._awaitingChangeset||this._acknowledgedAwaitingChangeset].filter(h=>!!h);let i,r;if(s.length){const h=this._transformService.transformChangesets(e,s,!1);if(!u.isTransformChangesetsSuccess(h))throw h.error;i=h.c1Prime,r=h.c2Prime}else i=e,r=[];let a=this._pendingMutations;i.forEach(h=>{let l;if(a.length){const S=this._transformService.transformMutationsWithChangeset(h,a);if(!u.isTransformMutationsWithChangesetSuccess(S))throw S.error;l=S.c1Prime,a=S.m2Prime}else l=h;this._executeRemoteChangeset(l)}),this._acknowledgedAwaitingChangeset&&this._incrementRevisionNumber(),this._awaitingChangeset&&r.length&&(r[0].baseRev=this._getCurrentRevision());let c;if(this._awaitingChangeset&&a.length!==0)c=this._injector.createInstance(k,this.unitID,this.type,r[0],a,this._handler);else if(this._awaitingChangeset&&a.length===0)r[0].baseRev=this._getCurrentRevision(),c=this._injector.createInstance(F,this.unitID,this.type,r[0],this._handler);else if(a.length!==0){const h=this._injector.createInstance(H,this.unitID,this.type,a,this._handler);h._schedule(),c=h}else c=this._injector.createInstance(ie,this.unitID,this.type,this._handler);return c._updateLocalCache(),c}catch(e){return this._logService.error("[FetchMissState]","failed to apply missed changesets!",e),this._injector.createInstance(V,this.unitID,this.type,this._awaitingChangeset,this._pendingMutations,this._handler,!1)}}resend(){throw new Error("[FetchingMissState]: invalid calling to `resend`.")}appendMutation(t){return this._pendingMutations.push(t),this}onRemoteChangeset(t){return this._queuedRemoteChangesets.push(t),this}onRemoteAck(t){if(this._awaitingChangeset)return this._acknowledgedAwaitingChangeset=this._awaitingChangeset,this._awaitingChangeset=null,this;throw new Error("[FetchingMissState]: not expected to receive ack when `this._awaitingChangeset` is null!")}onRemoteRej(t){return this._onConflict(!!(t!=null&&t.isPermissionRej))}toggleOffline(){return this._injector.createInstance(W,this.unitID,this.type,this._awaitingChangeset,this._pendingMutations,this._handler)}toggleOnline(){return this}_onConflict(t){return this._injector.createInstance(V,this.unitID,this.type,this._awaitingChangeset,this._pendingMutations,this._handler,t)}};B=x([m(7,o.Inject(o.Injector)),m(8,o.Inject(u.RevisionService)),m(9,o.Inject(_.LocalCacheService)),m(10,o.ILogService),m(11,o.ICommandService),m(12,o.IUndoRedoService),m(13,u.ITransformService)],B);function St(n,t,e,s,i,r){return s&&i.length?n.createInstance(k,t,e,s,i,r):s?n.createInstance(F,t,e,s,r):i.length?n.createInstance(H,t,e,i,r):n.createInstance(ie,t,e,r)}var fs=Object.defineProperty,ms=Object.getOwnPropertyDescriptor,ve=(n,t,e,s)=>{for(var i=s>1?void 0:s?ms(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&fs(t,e,i),i},E=(n,t)=>(e,s)=>t(e,s,n);_.CollaborationController=class extends o.RxDisposable{constructor(e,s,i){super();d(this,"_entities",new Map);d(this,"_entityInit$",new f.Subject);this._injector=e,this._collabSessionService=s,this._univerInstanceService=i,this._init()}dispose(){super.dispose(),this._entities.forEach(e=>e.dispose()),this._entities.clear()}getCollabEntity(e){var s;return(s=this._entities.get(e))!=null?s:null}getCollabEntity$(e){const s=this.getCollabEntity(e);return s?f.of(s):this._entityInit$.pipe(C.filter(i=>i.unitID===e))}_init(){this._univerInstanceService.getTypeOfUnitAdded$(o.UniverInstanceType.UNIVER_SHEET).pipe(f.takeUntil(this.dispose$),C.delay(16)).subscribe(async s=>{const i=s.getUnitId(),r=await this._startCollaboration(i,j.UNIVER_SHEET);this._entities.set(i,r)}),this._univerInstanceService.getTypeOfUnitAdded$(o.UniverInstanceType.UNIVER_DOC).pipe(f.takeUntil(this.dispose$),C.delay(16)).pipe(C.filter(s=>!s.getUnitId().startsWith("__"))).subscribe(async s=>{const i=s.getUnitId(),r=await this._startCollaboration(i,j.UNIVER_DOC);this._entities.set(i,r)}),f.merge(this._univerInstanceService.getTypeOfUnitDisposed$(o.UniverInstanceType.UNIVER_SHEET),this._univerInstanceService.getTypeOfUnitDisposed$(o.UniverInstanceType.UNIVER_DOC)).pipe(f.takeUntil(this.dispose$)).subscribe(s=>{const i=s.getUnitId(),r=this._entities.get(i);r&&(r.dispose(),this._entities.delete(i))})}async _startCollaboration(e,s){const i=await this._collabSessionService.requireSession(e),r=this._injector.createInstance(this._getCtorByUniverType(s),e,s,i);return await r.init(),this._entityInit$.next(r),r}_getCtorByUniverType(e){switch(e){case j.UNIVER_DOC:return ye;case j.UNIVER_SHEET:return _.SheetCollaborationEntity;default:throw new Error(`[CollaborationController]: invalid univer type: ${e}`)}}},_.CollaborationController=ve([o.OnLifecycle(o.LifecycleStages.Starting,_.CollaborationController),E(0,o.Inject(o.Injector)),E(1,o.Inject(_.CollaborationSessionService)),E(2,o.IUniverInstanceService)],_.CollaborationController);let fe=class extends o.RxDisposable{constructor(t,e,s,i,r,a,c,h,l,S,v,I,g){super();d(this,"_state$",new f.BehaviorSubject(null));d(this,"state$",this._state$.asObservable());d(this,"_state");d(this,"_collaborationPaused",!1);d(this,"status$",this.state$.pipe(C.map(t=>t?t.status:P.OFFLINE),C.shareReplay(1)));d(this,"_transitionLocked",!1);d(this,"_remoteChangesetQueue",[]);this.unitID=t,this._type=e,this._session=s,this._injector=i,this._localCacheService=r,this._compressMutationService=a,this._localeService=c,this._revisionService=h,this._logService=l,this._commandService=S,this._messageService=v,this._permissionService=I,this._singleActiveUnitService=g}get state(){return this._state}async init(){if(this.state)throw new Error('[CollaborationEntity]: initial state has been created before. You should not call "init" twice.');await this._init()}pauseCollaboration(){return this._collaborationPaused=!0,o.toDisposable(()=>{this._collaborationPaused=!1,this._exhaustRemoteChangesetQueue()})}_updateState(t){this._state=t,this._state$.next(t)}async _init(){var t;return this._updateState(await this._createInitialState()),this._singleActiveUnitService&&((t=this._singleActiveUnitService)==null||t.editingUnit(this.unitID),this.disposeWithMe(o.toDisposable(this._singleActiveUnitService.getUnitStatus$(this.unitID).subscribe(e=>{this._logService.debug("[CollaborationEntity]","editing status changed to",e),e===ot.OTHER_CLIENTS_EDITING?(this._messageService.show({content:this._localeService.t("collaboration.single-unit.warning"),type:z.MessageType.Warning}),this._permissionService.updatePermissionPoint(new p.WorkbookEditablePermission(this.unitID).id,!1)):this._permissionService.updatePermissionPoint(new p.WorkbookEditablePermission(this.unitID).id,!0)})))),this.disposeWithMe(o.toDisposable(this._session.sessionStatus$.subscribe(e=>{e===Y.ONLINE?this._toggleOnline():e===Y.OFFLINE&&this._toggleOffline()}))),this.disposeWithMe(o.toDisposable(this._session.event$.subscribe(e=>{try{switch(e.eventID){case u.CollaborationEvent.NEW_CHANGESETS:{this._onRemoteChangeset(u.parseProtocolChangeset(e.data));break}case u.CollaborationEvent.CHANGESET_ACK:{this._onRemoteACK(e.data);break}case u.CollaborationEvent.CHANGESET_REJ:{this._onRemoteRejected();break}case u.CollaborationEvent.PSEUDO_FETCH_MISSING_RESULT:{this._onFetchMissResult(e.data.changesets.map(i=>u.parseProtocolChangeset(i)));break}case u.CollaborationEvent.PERMISSION_REJ:this._onRemoteRejected({isPermissionRej:!0})}}catch(s){throw console.error("Error on receiving event",s),s}}))),this._state}_unlockTransition(){this._transitionLocked=!1}_lockTransition(){if(this._transitionLocked)throw new Error("[CollaborationEntity]: cannot lock transition twice! This is an implementation error, meaning you transit the collaboration state again in the process of a previous transition. This should never happen.");this._transitionLocked=!0}_onLocalMutation(t){this._lockTransition(),this._updateState(this._state.appendMutation(t)),this._unlockTransition()}_onRemoteChangeset(t){if(!(t.revision<=this._revisionService.getCurrentRevForDocument(this.unitID))){if(this._collaborationPaused){this._remoteChangesetQueue.push(t);return}this._applyRemoteChangeset(t)}}_exhaustRemoteChangesetQueue(){this._remoteChangesetQueue.forEach(t=>this._applyRemoteChangeset(t)),this._remoteChangesetQueue=[]}_applyRemoteChangeset(t){const e=this._compressMutationService.interceptor.fetchThroughInterceptors(this._compressMutationService.interceptor.getInterceptPoints().COMPRESS_MUTATION_APPLY)(t.mutations,null)||t.mutations,s={...t,mutations:e};this._lockTransition(),this._updateState(this._state.onRemoteChangeset(s)),this._unlockTransition()}_onRemoteACK(t){this._lockTransition(),this._updateState(this._state.onRemoteAck(t)),this._unlockTransition()}_onRemoteRejected(t){this._lockTransition(),this._updateState(this._state.onRemoteRej(t)),this._unlockTransition()}_onFetchMissResult(t){if(!(this._state instanceof B))throw new TypeError("[CollaborationEntity]: cannot apply missing results on other states!");const e=t.map(s=>{const i=this._compressMutationService.interceptor.fetchThroughInterceptors(this._compressMutationService.interceptor.getInterceptPoints().COMPRESS_MUTATION_APPLY)(s.mutations,null)||s.mutations;return{...s,mutations:i}});this._lockTransition(),this._updateState(this._state.onMissedChangesetFetched(e)),this._unlockTransition()}_toggleOffline(){this._lockTransition(),this._updateState(this._state.toggleOffline()),this._unlockTransition()}_toggleOnline(){this._lockTransition(),this._updateState(this._state.toggleOnline()),this._unlockTransition()}async _createInitialState(){return new Promise(t=>{this._session.sessionStatus$.pipe(C.take(1)).subscribe(async e=>{t(await this._createInitialStateImpl(e===Y.ONLINE))})})}_createHandler(){const t=this.unitID;return{onStateChange:(s,i)=>{if(s!==this._state)throw new Error(`[ClientCollaborationController]: invalid state transition! State transferred from is not the current state.
Before: ${s.status}
After: ${i.status}
Current: ${this._state.status}`);this._updateState(i)},onSendChangeset:s=>{const i={eventID:u.CollaborationEvent.SUBMIT_CHANGESET,data:{unitID:s.unitID,unitType:this._type,changeset:s,memberID:this._session.getMemberID()}};this._session.send(i,this.unitID)},onMissingChangesets:({from:s,to:i})=>{this._logService.debug("[CollaborationEntity]",`fetching missing changesets from ${s} to ${i}`);const r={eventID:u.CollaborationEvent.FETCH_MISSING,data:{unitID:t,unitType:this._type,from:s,to:i}};this._session.send(r,this.unitID)}}}async _createInitialStateImpl(t){var c,h;const e=await this._localCacheService.loadOfflineData(this.unitID),s=(c=e==null?void 0:e.mutations)!=null?c:[],i=(h=e==null?void 0:e.awaitingChangeset)!=null?h:null,r=this.unitID;try{this._replayCachedMutations(i,s)}catch(l){this._logService.error(l)}const a=this._createHandler();if(t){const l=St(this._injector,r,this._type,i,s,a);return l instanceof H?l._schedule():(l instanceof k||l instanceof F)&&l.resend(),l}return this._injector.createInstance(W,r,this._type,i,s,a)}_replayCachedMutations(t,e){var i,r;const s=this._compressMutationService.interceptor.fetchThroughInterceptors(this._compressMutationService.interceptor.getInterceptPoints().COMPRESS_MUTATION_APPLY);(i=s((t==null?void 0:t.mutations)||[],null))==null||i.forEach(a=>this._commandService.executeCommand(a.id,a.params)),(r=s(e||[],null))==null||r.forEach(a=>this._commandService.executeCommand(a.id,a.params))}};fe=ve([E(3,o.Inject(o.Injector)),E(4,o.Inject(_.LocalCacheService)),E(5,o.Inject(u.CompressMutationService)),E(6,o.Inject(o.LocaleService)),E(7,o.Inject(u.RevisionService)),E(8,o.ILogService),E(9,o.ICommandService),E(10,L.IMessageService),E(11,o.IPermissionService),E(12,o.Optional(_e))],fe);let ye=class extends fe{constructor(n,t,e,s,i,r,a,c,h,l,S,v,I,g,T,D,O){super(n,t,e,s,i,r,a,c,I,g,T,D,O),this.unitID=n,this.type=t,this.session=e,this._docStateChangeManagerService=h,this._docTransformIMECacheService=l,this._docTransformSelectionsService=S,this._docSyncEditingCollabCursorService=v}_createHandler(){const n=super._createHandler();return n.onTransformIME=t=>this._docTransformIMECacheService.transformIMECache(t),n.onTransformSelections=t=>this._docTransformSelectionsService.transformSelections(t),n.onSyncEditingCollabCursor=t=>this._docSyncEditingCollabCursorService.syncEditingCollabCursor(t),n.onTransformRemoteChangesetByIMECache=t=>this._docTransformIMECacheService.transformRemoteChangeset(t),n}async _init(){const n=await super._init();return this.disposeWithMe(this._commandService.onCommandExecuted((t,e)=>{if(t.type!==o.CommandType.MUTATION||e!=null&&e.fromCollab||e!=null&&e.onlyLocal)return;const s=t.params;if((s==null?void 0:s.unitId)!==this.unitID)return;let i=t;if(i.id===U.RichTextEditingMutation.id){const a=i.params;i={id:U.RichTextEditingMutation.id,type:o.CommandType.MUTATION,params:{unitId:a.unitId,actions:a.actions,textRanges:null}}}const r=this._compressMutationService.interceptor.fetchThroughInterceptors(this._compressMutationService.interceptor.getInterceptPoints().COMPRESS_MUTATION_SEND)([i],null)||[i];this._onLocalMutation(r[0])})),n}};ye=ve([E(3,o.Inject(o.Injector)),E(4,o.Inject(_.LocalCacheService)),E(5,o.Inject(u.CompressMutationService)),E(6,o.Inject(o.LocaleService)),E(7,o.Inject(u.RevisionService)),E(8,o.Inject(U.DocStateChangeManagerService)),E(9,o.Inject(ue)),E(10,o.Inject(de)),E(11,o.Inject(Pe)),E(12,o.ILogService),E(13,o.ICommandService),E(14,L.IMessageService),E(15,o.IPermissionService),E(16,o.Optional(_e))],ye),_.SheetCollaborationEntity=class extends fe{constructor(t,e,s,i,r,a,c,h,l,S,v,I,g,T){super(t,e,s,i,r,a,c,h,S,v,I,g,T),this.unitID=t,this.type=e,this.session=s,this._sheetTransformSelectionsService=l}_createHandler(){const t=super._createHandler();return t.onTransformSelections=e=>this._sheetTransformSelectionsService.transformSelections(e),t}async _init(){const t=await super._init();return this.disposeWithMe(this._commandService.onCommandExecuted((e,s)=>{if(e.type!==o.CommandType.MUTATION||s!=null&&s.fromCollab||s!=null&&s.onlyLocal)return;const i=e.params;if((i==null?void 0:i.unitId)!==this.unitID)return;const r=e,a=this._compressMutationService.interceptor.fetchThroughInterceptors(this._compressMutationService.interceptor.getInterceptPoints().COMPRESS_MUTATION_SEND)([r],null)||[r];this._onLocalMutation(a[0])})),t}},_.SheetCollaborationEntity=ve([E(3,o.Inject(o.Injector)),E(4,o.Inject(_.LocalCacheService)),E(5,o.Inject(u.CompressMutationService)),E(6,o.Inject(o.LocaleService)),E(7,o.Inject(u.RevisionService)),E(8,o.Inject(Se)),E(9,o.ILogService),E(10,o.ICommandService),E(11,L.IMessageService),E(12,o.IPermissionService),E(13,o.Optional(_e))],_.SheetCollaborationEntity);const vt=["purple300","jiqing500","verdancy600","red300","blue400","gold400"];class Ne extends o.Disposable{constructor(){super(...arguments);d(this,"_assignedColors",new Map);d(this,"_colorIndex",0)}assignAColorForMemberID(e){if(this._assignedColors.has(e))return this._assignedColors.get(e);const s=vt[this._colorIndex];return this._colorIndex=(this._colorIndex+1)%vt.length,this._assignedColors.set(e,s),s}}var Is=Object.defineProperty,gs=Object.getOwnPropertyDescriptor,ps=(n,t,e,s)=>{for(var i=s>1?void 0:s?gs(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Is(t,e,i),i},Z=(n,t)=>(e,s)=>t(e,s,n);const Es=300,Cs=100,Ts=()=>{let n=[],t=!1;return e=>{n.push(e),t||(t=!0,setTimeout(()=>{n.forEach(s=>s()),n=[],t=!1}))}};let Ae=class extends o.RxDisposable{constructor(t,e,s,i,r,a,c,h){super();d(this,"_online",!1);d(this,"_init",!1);d(this,"_cursorInfo$",new f.BehaviorSubject(new Map));d(this,"cursorInfo$",this._cursorInfo$.asObservable());d(this,"_roomMembers$",new f.BehaviorSubject([]));d(this,"roomMembers$",this._roomMembers$.pipe(f.debounceTime(Es)));d(this,"_updateLocalCursor",be((t,e)=>{const s={eventID:u.CollaborationEvent.UPDATE_CURSOR,data:{unitID:this.unitID,memberID:this._session.getMemberID(),selection:xe.serializeRangeWithSheet(t,e.range)}};this._session.send(s,this.unitID)},Cs));this.unitID=t,this._session=e,this._injector=s,this._colorAssignService=i,this._memberService=r,this._univerInstanceService=a,this._commandService=c,this._refRangeService=h}get cursorInfo(){return this._cursorInfo$.getValue()}get roomMembers(){return this._roomMembers$.getValue()}dispose(){super.dispose(),this._cursorInfo$.next(new Map),this._cursorInfo$.complete(),this._roomMembers$.next([]),this._roomMembers$.complete()}init(){this._init||(this._init=!0,this._session.sessionStatus$.pipe(f.takeUntil(this.dispose$)).subscribe(t=>{t===Y.ONLINE?this._toggleOnline():this._toggleOffline()}),this._session.event$.pipe(f.takeUntil(this.dispose$)).subscribe(t=>{const e=t.eventID;e===u.CollaborationEvent.UPDATE_CURSOR&&this._onCursorUpdate(t),e===u.CollaborationEvent.USERS_LEAVE&&this._onCursorDelete(t)}),this._onRefRangeChange(),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(this._online&&t.id===p.SetSelectionsOperation.id&&t.params.unitId===this.unitID){const e=t.params;this._updateLocalCursor(e.subUnitId,e.selections[0])}})))}_onCursorUpdate(t){var l,S;const{memberID:e,selection:s}=t.data,{sheetName:i,range:r}=xe.deserializeRangeWithSheet(s),c={name:(S=(l=this._memberService.getMember(this.unitID,e))==null?void 0:l.name)!=null?S:"Unknown user",range:this._getMergeRange(i,r),sheetID:i,color:this._colorAssignService.assignAColorForMemberID(e),selection:s},h=this.cursorInfo;h.set(e,c),this._cursorInfo$.next(h)}_onCursorDelete(t){const{memberID:e}=t.data,s=this.cursorInfo;s.delete(e),this._cursorInfo$.next(s)}_getMergeRange(t,e){var i,r;const s=(r=(i=this._univerInstanceService.getUniverSheetInstance(this.unitID))==null?void 0:i.getSheetBySheetId(t))==null?void 0:r.getMergeData();return(s==null?void 0:s.find(a=>o.Rectangle.contains(a,e)))||e}_onRefRangeChange(){const t=new o.DisposableCollection,e=Ts(),s=()=>{t.dispose();const i=(r,a,c,h)=>{let l=[];switch(r.id){case p.EffectRefRangId.DeleteRangeMoveLeftCommandId:{l=p.handleDeleteRangeMoveLeft(r,h);break}case p.EffectRefRangId.DeleteRangeMoveUpCommandId:{l=p.handleDeleteRangeMoveUp(r,h);break}case p.EffectRefRangId.InsertColCommandId:{l=p.handleInsertCol(r,h);break}case p.EffectRefRangId.InsertRangeMoveDownCommandId:{l=p.handleInsertRangeMoveDown(r,h);break}case p.EffectRefRangId.InsertRangeMoveRightCommandId:{l=p.handleInsertRangeMoveRight(r,h);break}case p.EffectRefRangId.InsertRowCommandId:{l=p.handleInsertRow(r,h);break}case p.EffectRefRangId.MoveRangeCommandId:{l=p.handleMoveRange(r,h);break}case p.EffectRefRangId.RemoveColCommandId:{l=p.handleIRemoveCol(r,h);break}case p.EffectRefRangId.RemoveRowCommandId:{l=p.handleIRemoveRow(r,h);break}}const S=p.runRefRangeMutations(l,h),v=this.cursorInfo.get(a);if(v&&S){const I={...v,range:S};this.cursorInfo.set(a,I),e(()=>{const g=this._refRangeService.registerRefRange(S,T=>(g.dispose(),i(T,a,c,S)));t.add(g)})}return{redos:[],undos:[]}};this.cursorInfo.forEach((r,a)=>{const{range:c,sheetID:h}=r,l=this._refRangeService.registerRefRange(c,S=>(l.dispose(),i(S,a,h,c)));t.add(l)})};this.disposeWithMe(o.toDisposable(this._cursorInfo$.subscribe(()=>{s()})))}_toggleOnline(){var i,r;if(this._online=!0,((i=this._univerInstanceService.getFocusedUnit())==null?void 0:i.getUnitId())!==this.unitID)return;const e=(r=this._injector.get(p.SheetsSelectionsService).getCurrentSelections())==null?void 0:r[0],s=this._univerInstanceService.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET).getActiveSheet();e&&s&&this._updateLocalCursor(s.getSheetId(),e)}_toggleOffline(){this._online=!1}};Ae=ps([Z(2,o.Inject(o.Injector)),Z(3,o.Inject(Ne)),Z(4,o.Inject(G)),Z(5,o.IUniverInstanceService),Z(6,o.ICommandService),Z(7,o.Inject(p.RefRangeService))],Ae);var bs=Object.defineProperty,Rs=Object.getOwnPropertyDescriptor,Os=(n,t,e,s)=>{for(var i=s>1?void 0:s?Rs(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&bs(t,e,i),i},X=(n,t)=>(e,s)=>t(e,s,n);const Ds=300,Us=100;let Me=class extends o.RxDisposable{constructor(t,e,s,i,r,a,c,h,l){super();d(this,"_online",!1);d(this,"_init",!1);d(this,"_cursorInfo$",new f.BehaviorSubject(new Map));d(this,"cursorInfo$",this._cursorInfo$.asObservable());d(this,"_roomMembers$",new f.BehaviorSubject([]));d(this,"roomMembers$",this._roomMembers$.pipe(f.debounceTime(Ds)));d(this,"_updateLocalCursor",be(t=>{const e={eventID:u.CollaborationEvent.UPDATE_CURSOR,data:{unitID:this.unitID,memberID:this._session.getMemberID(),selection:_t(t)}};this._session.send(e,this.unitID)},Us));this.unitID=t,this._session=e,this._injector=s,this._colorAssignService=i,this._memberService=r,this._syncEditingCollabCursorService=a,this._transformService=c,this._univerInstanceService=h,this._commandService=l}get cursorInfo(){return this._cursorInfo$.getValue()}get roomMembers(){return this._roomMembers$.getValue()}dispose(){super.dispose(),this._cursorInfo$.next(new Map),this._cursorInfo$.complete(),this._roomMembers$.next([]),this._roomMembers$.complete()}init(){this._init||(this._init=!0,this._session.sessionStatus$.pipe(f.takeUntil(this.dispose$)).subscribe(t=>{t===Y.ONLINE?this._toggleOnline():this._toggleOffline()}),this._session.event$.pipe(f.takeUntil(this.dispose$)).subscribe(t=>{const e=t.eventID;e===u.CollaborationEvent.UPDATE_CURSOR&&this._onCursorUpdate(t),e===u.CollaborationEvent.USERS_LEAVE&&this._onCursorDelete(t)}),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{const e=t.params;e!=null&&this._online&&t.id===U.SetTextSelectionsOperation.id&&e.unitId===this.unitID&&e.isEditing===!1&&this._updateLocalCursor(e.ranges)})),this._syncEditingCollabCursorService.collabCursorState$.pipe(f.takeUntil(this.dispose$)).subscribe(t=>{if((t==null?void 0:t.unitID)!==this.unitID)return;const e={eventID:u.CollaborationEvent.UPDATE_CURSOR,data:t};this._onCursorUpdate(e)}),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.params==null)return;const e=t.params;if(t.id!==U.RichTextEditingMutation.id||e.unitId!==this.unitID)return;const s={id:"doc.mutation.rich-text-editing",params:e},i=this.cursorInfo;for(const[r,a]of i){const c={id:"doc.mutation.rich-text-editing",params:{unitId:this.unitID,actions:null,textRanges:a.ranges}},h=this._transformService.transformMutation(s,c,!1);if(u.isTransformMutationFailure(h))throw h.error;i.set(r,{...a,ranges:h.m2Prime.params.textRanges})}queueMicrotask(()=>{this._cursorInfo$.next(i)})})))}_onCursorUpdate(t){var h,l;const{memberID:e,selection:s}=t.data,i=os(s),r=(l=(h=this._memberService.getMember(this.unitID,e))==null?void 0:h.name)!=null?l:"Unknown user",a={color:this._colorAssignService.assignAColorForMemberID(e),name:r,ranges:i},c=this.cursorInfo;c.set(e,a),this._cursorInfo$.next(c)}_onCursorDelete(t){const{memberID:e}=t.data,s=this.cursorInfo;s.delete(e),this._cursorInfo$.next(s)}_toggleOnline(){var i;if(this._online=!0,((i=this._univerInstanceService.getFocusedUnit())==null?void 0:i.getUnitId())!==this.unitID)return;const e=this._injector.get(U.TextSelectionManagerService).getDocRanges(),s=e==null?void 0:e.map(U.serializeDocRange);Array.isArray(s)&&s.length>0&&this._updateLocalCursor(s)}_toggleOffline(){this._online=!1}};Me=Os([X(2,o.Inject(o.Injector)),X(3,o.Inject(Ne)),X(4,o.Inject(G)),X(5,o.Inject(Pe)),X(6,u.ITransformService),X(7,o.IUniverInstanceService),X(8,o.ICommandService)],Me);var Ps=Object.defineProperty,ys=Object.getOwnPropertyDescriptor,Ns=(n,t,e,s)=>{for(var i=s>1?void 0:s?ys(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Ps(t,e,i),i},Le=(n,t)=>(e,s)=>t(e,s,n);let Q=class extends o.RxDisposable{constructor(t,e,s){super();d(this,"_entities",new Map);d(this,"_entityInit$",new f.Subject);this._univerInstanceService=t,this._injector=e,this._collabSessionService=s,this._init()}dispose(){super.dispose(),this._entityInit$.complete(),this._entities.forEach(t=>t.dispose())}getCollabCursors$(t){return this._entities.has(t)?this._entities.get(t).cursorInfo$:this._entityInit$.pipe(f.filter(e=>e.unitID===t),f.switchMap(e=>e.cursorInfo$))}_init(){this._univerInstanceService.getTypeOfUnitAdded$(o.UniverInstanceType.UNIVER_SHEET).pipe(f.takeUntil(this.dispose$)).subscribe(async t=>{const e=t.getUnitId(),s=await this._startSheetCollabCursor(e);this._entityInit$.next(s),this._entities.set(e,s)}),this._univerInstanceService.getTypeOfUnitAdded$(o.UniverInstanceType.UNIVER_DOC).pipe(f.takeUntil(this.dispose$)).pipe(f.filter(t=>!t.getUnitId().startsWith("__"))).subscribe(async t=>{const e=t.getUnitId(),s=await this._startDocCollabCursor(e);this._entityInit$.next(s),this._entities.set(e,s)}),f.merge(this._univerInstanceService.getTypeOfUnitDisposed$(o.UniverInstanceType.UNIVER_DOC),this._univerInstanceService.getTypeOfUnitDisposed$(o.UniverInstanceType.UNIVER_SHEET)).pipe(f.takeUntil(this.dispose$)).subscribe(t=>{const e=t.getUnitId(),s=this._entities.get(e);s&&(s.dispose(),this._entities.delete(e))})}async _startSheetCollabCursor(t){const e=await this._collabSessionService.requireSession(t),s=this._injector.createInstance(Ae,t,e);return s.init(),s}async _startDocCollabCursor(t){const e=await this._collabSessionService.requireSession(t),s=this._injector.createInstance(Me,t,e);return s.init(),s}};Q=Ns([o.OnLifecycle(o.LifecycleStages.Starting,Q),Le(0,o.IUniverInstanceService),Le(1,o.Inject(o.Injector)),Le(2,o.Inject(_.CollaborationSessionService))],Q);const ne=20,ft=200,we=4,As=5;function Ms(n,t){let{radius:e,width:s,height:i}=t;e=e!=null?e:0,s=s!=null?s:30,i=i!=null?i:30;let r=0,a=0,c=0;r=a=c=Math.min(e,s/2,i/2),n.beginPath(),n.moveTo(r,0),n.lineTo(s-a,0),n.arc(s-a,a,a,Math.PI*3/2,0,!1),n.lineTo(s,i-c),n.arc(s-c,i-c,c,0,Math.PI/2,!1),n.lineTo(0,i),n.lineTo(0,r),n.arc(r,r,r,Math.PI,Math.PI*3/2,!1),n.closePath(),t.fill&&(n.save(),n.fillStyle=t.fill,t.fillRule==="evenodd"?n.fill("evenodd"):n.fill(),n.restore())}class me extends b.Shape{constructor(e,s){super(e,s);d(this,"color");d(this,"text");this.color=s==null?void 0:s.color,this.text=s==null?void 0:s.text}static drawWith(e,s){const{text:i,color:r}=s;e.save(),e.font="bold 13px Source Han Sans CN";const a=e.measureText(i).width,c=Math.min(a+2*we,ft);Ms(e,{height:ne,radius:4,width:c,fill:r,evented:!1}),e.fillStyle="#FFF";const h=we,l=ne-As,S=ft-2*we;if(a>S){let v="",I=0;for(const g of i){const T=e.measureText(g).width;if(I+T<=S-e.measureText("...").width)v+=g,I+=T;else{v+="...";break}}e.fillText(v,h,l)}else e.fillText(i,h,l);e.restore()}_draw(e){me.drawWith(e,this)}}const Ls=1,ws=1.5;class mt extends b.Shape{constructor(e,s){super(e,s);d(this,"_color");d(this,"_hovered",!1);d(this,"_range");d(this,"_name","");d(this,"_labelPosition","top");d(this,"_backgroundColor");s&&this.setShapeProps(s),this.onPointerEnter$.subscribeEvent(()=>this.setShapeProps({hovered:!0})),this.onPointerLeave$.subscribeEvent(()=>this.setShapeProps({hovered:!1}))}setShapeProps(e){var s,i,r,a,c,h;this._color=(s=e.color)!=null?s:this._color,this._hovered=(i=e.hovered)!=null?i:this._hovered,this._range=(r=e.range)!=null?r:this._range,this._name=(a=e.name)!=null?a:this._name,this._labelPosition=(c=e.labelPosition)!=null?c:this._labelPosition,this._backgroundColor=(h=e.backgroundColor)!=null?h:this._backgroundColor,this.transformByState({width:e.width,height:e.height})}onMouseMove(e){const{row:s,column:i}=e;if(s>=this._range.startRow&&s<=this._range.endRow&&i>=this._range.startColumn&&i<=this._range.endColumn){this.setShapeProps({hovered:!0});return}this.setShapeProps({hovered:!1})}triggerDblclick(e){return!1}_draw(e){b.Rect.drawWith(e,{width:this.width,height:this.height,strokeWidth:ws,stroke:this._color,evented:!1,fill:this._backgroundColor}),this._hovered&&(e.save(),e.transform(1,0,0,1,this.width,this._labelPosition==="bottom"?0:-ne),me.drawWith(e,{text:this._name,color:this._color}),e.restore())}}var $s=Object.defineProperty,js=Object.getOwnPropertyDescriptor,Hs=(n,t,e,s)=>{for(var i=s>1?void 0:s?js(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&$s(t,e,i),i},$e=(n,t)=>(e,s)=>t(e,s,n);const ks=5001;let je=class extends o.RxDisposable{constructor(t,e,s,i){super();d(this,"_cursors",new Set);d(this,"_lastPointer",null);this._context=t,this._sheetSkeletonManagerService=e,this._collabCursorController=s,this._themeService=i,this._init()}_init(){this._sheetSkeletonManagerService.currentSkeleton$.pipe(C.takeUntil(this.dispose$),C.switchMap(t=>{if(t){const e=t.sheetId;return f.combineLatest(this._collabCursorController.getCollabCursors$(this._context.unitId),this._themeService.currentTheme$).pipe(C.map(([s,i])=>{const r=new Map;return s.forEach((a,c)=>{if(a.sheetID===e){const h={...a};h.color=i[a.color],r.set(c,h)}}),{skeleton:t,cursors:r}}))}return f.of({skeleton:null,cursors:new Map})})).subscribe(({skeleton:t,cursors:e})=>{this._removeCollabCursors(),t&&this._updateCollabCursors(t,e)}),this._sheetSkeletonManagerService.currentSkeleton$.subscribe(t=>{if(t==null)return;const{skeleton:e}=t,{scene:s}=this._context;s.onPointerMove$.subscribeEvent(be(i=>{var T,D;const{offsetX:r,offsetY:a}=i,{x:c,y:h}=s.getRelativeToViewportCoord(b.Vector2.FromArray([r,a])),{scaleX:l,scaleY:S}=s.getAncestorScale(),v=s.getViewport(J.VIEWPORT_KEY.VIEW_MAIN),I=s.getVpScrollXYInfoByPosToVp(b.Vector2.FromArray([c,h]),v),g=e.getCellPositionByOffset(r,a,l,S,I);((T=this._lastPointer)==null?void 0:T.column)===g.column&&((D=this._lastPointer)==null?void 0:D.row)===g.row||this._cursors.forEach(O=>{O.onMouseMove(g)})},100))})}_updateCollabCursors(t,e){var c;const s=(c=this._sheetSkeletonManagerService.getCurrent())==null?void 0:c.skeleton;if(!s)return;const i=this._getSheetObject();if(!i)return;this._cursors.forEach(h=>{h.makeDirty()});const{scene:r}=i,a=Bs(Array.from(e.values())).map(h=>{const{color:l,range:S,name:v,selection:I,sheetID:g}=h,{startColumn:T,startRow:D,endColumn:O,endRow:M}=S,q=J.getCoordByCell(D,T,r,s),Ge=J.getCoordByCell(M,O,r,s),{columnHeaderHeightAndMarginTop:he}=s,{startX:le,startY:Ye}=q,{endX:xi,endY:Ki}=Ge,Xi=xi-le,qi=Ki-Ye,zi={labelPosition:Ye-he>=ne?"top":"bottom",sheetID:g,range:S,color:l,name:v,selection:I,left:le,top:Ye,width:Xi,height:qi,evented:!1,zIndex:ks};return new mt(v,zi)});r.addObjects(a,Ls),this._cursors=new Set(a)}_removeCollabCursors(){var t;(t=this._cursors)==null||t.forEach(e=>e.dispose())}_getSheetObject(){return J.getSheetObject(this._context.unit,this._context)}};je=Hs([$e(1,o.Inject(J.SheetSkeletonManagerService)),$e(2,o.Inject(Q)),$e(3,o.Inject(o.ThemeService))],je);function Bs(n){const t=new Map;return n.forEach(e=>{if(t.has(e.selection)){const s=t.get(e.selection);s.name+=`, ${e.name}`}else t.set(e.selection,e)}),Array.from(t.values())}var w=function(){return w=Object.assign||function(n){for(var t,e=1,s=arguments.length;e<s;e++){t=arguments[e];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i])}return n},w.apply(this,arguments)},Fs=function(n,t){var e={};for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&t.indexOf(s)<0&&(e[s]=n[s]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,s=Object.getOwnPropertySymbols(n);i<s.length;i++)t.indexOf(s[i])<0&&Object.prototype.propertyIsEnumerable.call(n,s[i])&&(e[s[i]]=n[s[i]]);return e},He=N.forwardRef(function(n,t){var e=n.icon,s=n.id,i=n.className,r=n.extend,a=Fs(n,["icon","id","className","extend"]),c="univerjs-icon univerjs-icon-".concat(s," ").concat(i||"").trim(),h=N.useRef("_".concat(Gs()));return It(e,"".concat(s),{defIds:e.defIds,idSuffix:h.current},w({ref:t,className:c},a),r)});function It(n,t,e,s,i){return N.createElement(n.tag,w(w({key:t},Vs(n,e,i)),s),(Ws(n,e).children||[]).map(function(r,a){return It(r,"".concat(t,"-").concat(n.tag,"-").concat(a),e,void 0,i)}))}function Vs(n,t,e){var s=w({},n.attrs);e!=null&&e.colorChannel1&&s.fill==="colorChannel1"&&(s.fill=e.colorChannel1);var i=t.defIds;return!i||i.length===0||(n.tag==="use"&&s["xlink:href"]&&(s["xlink:href"]=s["xlink:href"]+t.idSuffix),Object.entries(s).forEach(function(r){var a=r[0],c=r[1];typeof c=="string"&&(s[a]=c.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),s}function Ws(n,t){var e,s=t.defIds;return!s||s.length===0?n:n.tag==="defs"&&(!((e=n.children)===null||e===void 0)&&e.length)?w(w({},n),{children:n.children.map(function(i){return typeof i.attrs.id=="string"&&s&&s.indexOf(i.attrs.id)>-1?w(w({},i),{attrs:w(w({},i.attrs),{id:i.attrs.id+t.idSuffix})}):i})}):n}function Gs(){return Math.random().toString(36).substring(2,8)}He.displayName="UniverIcon";var Ys={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"g",attrs:{clipPath:"url(#off-line-single_clip0_910_343)"},children:[{tag:"path",attrs:{stroke:"currentColor",d:"M3.61971 11.6499C2.40304 11.6499 0.699707 11.1024 0.699707 8.9124C0.699707 6.3574 3.25471 5.8099 3.98471 5.8099C4.34971 4.5324 5.07971 2.5249 7.99971 2.5249C10.5547 2.5249 11.6497 3.9849 12.0147 5.2624C12.0147 5.2624 15.2997 5.6274 15.2997 8.7299C15.2997 10.9199 13.8397 11.6499 12.3797 11.6499M9.82471 9.82466L6.17471 13.4747M6.17471 9.82466L9.82471 13.4747",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}}]},{tag:"defs",attrs:{},children:[{tag:"clipPath",attrs:{id:"off-line-single_clip0_910_343"},children:[{tag:"path",attrs:{fill:"#fff",d:"M0 0H16V16H0z"}}]}]}],defIds:["off-line-single_clip0_910_343"]},gt=N.forwardRef(function(n,t){return N.createElement(He,Object.assign({},n,{id:"off-line-single",ref:t,icon:Ys}))});gt.displayName="OffLineSingle";var xs={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"g",attrs:{clipPath:"url(#on-line-single_clip0_910_349)"},children:[{tag:"path",attrs:{stroke:"currentColor",d:"M4.5865 11.6499C3.36983 11.6499 1.6665 11.1024 1.6665 8.9124C1.6665 6.3574 4.2215 5.8099 4.9515 5.8099C5.3165 4.5324 6.0465 2.5249 8.9665 2.5249C11.5215 2.5249 12.6165 3.9849 12.9815 5.2624C12.9815 5.2624 16.2665 5.6274 16.2665 8.7299C16.2665 10.9199 14.8065 11.6499 13.3465 11.6499M6.7767 11.6497L8.9667 13.4747L11.8867 9.82466",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}}]},{tag:"defs",attrs:{},children:[{tag:"clipPath",attrs:{id:"on-line-single_clip0_910_349"},children:[{tag:"path",attrs:{fill:"#fff",d:"M0 0H16V16H0z",transform:"translate(.97)"}}]}]}],defIds:["on-line-single_clip0_910_349"]},pt=N.forwardRef(function(n,t){return N.createElement(He,Object.assign({},n,{id:"on-line-single",ref:t,icon:xs}))});pt.displayName="OnLineSingle";const re={onlineStatusIcon:"univer-online-status-icon",onlineStatusTitle:"univer-online-status-title",onlineStatus:"univer-online-status",online:"univer-online",offline:"univer-offline"};function Ks(n){switch(n){case P.OFFLINE:return"collabStatus.offline";case P.CONFLICT:return"collabStatus.conflict";case P.FETCH_MISS:return"collabStatus.fetchMiss";case P.NOT_COLLAB:return"collabStatus.notCollab";case P.PENDING:case P.AWAITING:case P.AWAITING_WITH_PENDING:return"collabStatus.syncing";case P.SYNCED:return"collabStatus.synced"}}function Et(n){const{status$:t}=n,e=L.useObservable(t,P.NOT_COLLAB),s=o.useDependency(o.LocaleService),i=e!==P.OFFLINE,r=s.t(Ks(e)),a=At(re.onlineStatus,{[re.online]:i,[re.offline]:!i}),c=i?N.createElement(pt,null):N.createElement(gt,null);return N.createElement("div",{className:a},N.createElement("div",{className:re.onlineStatusIcon},c),N.createElement("div",{className:re.onlineStatusTitle},r))}var Xs=Object.defineProperty,qs=Object.getOwnPropertyDescriptor,zs=(n,t,e,s)=>{for(var i=s>1?void 0:s?qs(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Xs(t,e,i),i},Ie=(n,t)=>(e,s)=>t(e,s,n);_.DesktopCollaborationStatusDisplayController=class extends o.Disposable{constructor(e,s,i,r){super();d(this,"_status$",new f.BehaviorSubject(P.NOT_COLLAB));this._univerInstanceService=e,this._uiPartsService=s,this._injector=i,this._collaborationController=r,this._initStatusComponent(),this._initStatusListener()}_initStatusComponent(){this.disposeWithMe(this._uiPartsService.registerComponent(L.BuiltInUIPart.HEADER_MENU,()=>o.connectInjector(Js({status$:this._status$.asObservable()}),this._injector)))}_initStatusListener(){this.disposeWithMe(o.toDisposable(this._univerInstanceService.focused$.pipe(f.switchMap(()=>{const e=this._univerInstanceService.getFocusedUnit();return e?this._collaborationController.getCollabEntity$(e.getUnitId()):f.of(null)}),f.switchMap(e=>e?e.status$:f.of(P.NOT_COLLAB))).subscribe(e=>{this._status$.next(e)})))}},_.DesktopCollaborationStatusDisplayController=zs([o.OnLifecycle(o.LifecycleStages.Starting,_.DesktopCollaborationStatusDisplayController),Ie(0,o.IUniverInstanceService),Ie(1,L.IUIPartsService),Ie(2,o.Inject(o.Injector)),Ie(3,o.Inject(_.CollaborationController))],_.DesktopCollaborationStatusDisplayController);function Js(n){const{status$:t}=n;return function(){return N.createElement(Et,{status$:t})}}const ke=o.createIdentifier("uni.network.url-service");var Zs=Object.defineProperty,Qs=Object.getOwnPropertyDescriptor,ei=(n,t,e,s)=>{for(var i=s>1?void 0:s?Qs(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Zs(t,e,i),i},ee=(n,t)=>(e,s)=>t(e,s,n);_.DataLoaderController=class extends o.RxDisposable{constructor(t,e,s,i,r,a){super(),this._urlService=t,this._logService=e,this._commandService=s,this._localCacheService=i,this._snapshotService=r,a?a==null||a.whenReady().then(()=>this._init()):(this._logService.debug("[DataLoaderController]","No remote instance service injected. May not syncing edits to the web worker."),this._init())}async _init(){const t=this._urlService.getParam("unit"),e=this._urlService.getParam("type");if(!t){if(!t||!e){this._logService.debug("[DataLoaderController]","No unitID or type in URL. Will not load files from remote address.");return}switch(Number(e)){case j.UNIVER_SHEET:{const s=await this._loadSheet(t);this._setupSubUnitSync(s);break}case j.UNIVER_DOC:{await this._loadDoc(t);break}default:{this._logService.error("[DataLoaderController]","Unknown type in URL. Will not load files from remote address.");break}}}}async _setupSubUnitSync(t){await this._updateSubUnitFromURLParams(t),t.activeSheet$.pipe(f.takeUntil(this.dispose$)).subscribe(e=>{e&&this._updateURLWithCurrentState(e)}),this._urlService.urlChange$.pipe(f.takeUntil(this.dispose$)).subscribe(()=>this._updateSubUnitFromURLParams(t))}_updateURLWithCurrentState(t,e=!1){const s=this._urlService.getParam("subunit");t.getSheetId()!==s&&this._urlService.setParam("subunit",t.getSheetId(),e)}async _updateSubUnitFromURLParams(t){var s;const e=this._urlService.getParam("subunit");if(!e||!t.getSheetBySheetId(e)){const i=t.getUnhiddenWorksheets()[0],r=t.getSheetBySheetId(i);if(!r)return;this._updateURLWithCurrentState(r,!0),await this._commandService.executeCommand(p.SetWorksheetActivateCommand.id,{unitId:t.getUnitId(),subUnitId:i});return}((s=t.getActiveSheet())==null?void 0:s.getSheetId())!==e&&await this._commandService.executeCommand(p.SetWorksheetActivateCommand.id,{unitId:t.getUnitId(),subUnitId:e})}async _loadSheet(t){let e=0;const s=await this._localCacheService.loadOfflineData(t);return s&&(s.awaitingChangeset||s.mutations.length!==0)&&(e=s.rev),e===0&&this._logService.debug("[DataLoaderController]","fetching the latest document from the server."),this._snapshotService.loadSheet(t,e)}async _loadDoc(t){let e=0;const s=await this._localCacheService.loadOfflineData(t);return s&&(s.awaitingChangeset||s.mutations.length!==0)&&(e=s.rev),e===0&&this._logService.debug("[DataLoaderController]","fetching the latest document from the server."),this._snapshotService.loadDoc(t,e)}},_.DataLoaderController=ei([o.OnLifecycle(o.LifecycleStages.Starting,_.DataLoaderController),ee(0,ke),ee(1,o.ILogService),ee(2,o.ICommandService),ee(3,o.Inject(_.LocalCacheService)),ee(4,o.Inject(u.SnapshotService)),ee(5,o.Optional(Mt.IRemoteInstanceService))],_.DataLoaderController);var ti=Object.defineProperty,si=Object.getOwnPropertyDescriptor,ii=(n,t,e,s)=>{for(var i=s>1?void 0:s?si(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&ti(t,e,i),i},Ct=(n,t)=>(e,s)=>t(e,s,n);const ni="DEFAULT_FILE_NAME",ri="Univer";let ge=class extends o.Disposable{constructor(n,t){super(),this._univerInstanceService=n,this._configService=t,this._init()}_init(){this.disposeWithMe(o.toDisposable(this._univerInstanceService.focused$.subscribe(()=>{var e;const n=this._univerInstanceService.getFocusedUnit();let t=(e=this._configService.getConfig(ni))!=null?e:ri;n instanceof o.Workbook&&(t=n.name),document.title=t})))}};ge=ii([o.OnLifecycle(o.LifecycleStages.Ready,ge),Ct(0,o.IUniverInstanceService),Ct(1,o.IConfigService)],ge);var oi=Object.defineProperty,ai=Object.getOwnPropertyDescriptor,ci=(n,t,e,s)=>{for(var i=s>1?void 0:s?ai(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&oi(t,e,i),i},Tt=(n,t)=>(e,s)=>t(e,s,n);_.SnapshotServerOverHTTPService=class{constructor(t,e){this._configService=t,this._httpService=e}async getUnitOnRev(t,e){var v;const{unitID:s,type:i,revision:r=0}=e,c=`${this._getSnapshotAPIPrefix()}/${i}/unit/${s}/rev/${r}`,l=(await this._httpService.get(c)).body,S=(v=l.snapshot)==null?void 0:v.workbook;if(S){const I=S==null?void 0:S.originalMeta,g=o.textEncoder.encode(o.b64DecodeUnicode(I));S.originalMeta=g,Object.entries(S.sheets).forEach(([,T])=>{const D=T.originalMeta,O=o.textEncoder.encode(o.b64DecodeUnicode(D));T.originalMeta=O})}return l}async getSheetBlock(t,e){const{unitID:s,type:i,blockID:r}=e,c=`${this._getAPIPrefix()}/${i}/unit/${s}/block/${r}`;return(await this._httpService.get(c)).body}async fetchMissingChangesets(t,e){const{unitID:s,type:i,from:r,to:a}=e,h=`${this._getAPIPrefix()}/${i}/unit/${s}/fetchmissing?from=${r}&to=${a}`;return(await this._httpService.get(h)).body}_getSnapshotAPIPrefix(){var t;return(t=this._configService.getConfig(Xe))!=null?t:this._getAPIPrefix()}_getAPIPrefix(){var t;return(t=this._configService.getConfig(Ke))!=null?t:Lt}async getResourcesRequest(t,e){const s=`/universer-api/snapshot/${e.type}/unit/${e.unitID}/resources`;return(await this._httpService.get(s,{params:{resourceId:JSON.stringify(e.resourceIDs)}})).body}saveSnapshot(){throw new Error("This method should not be called on the client side!")}saveSheetBlock(){throw new Error("This method should not be called on the client side!")}saveChangeset(){throw new Error("This method should not be called on the client side!")}},_.SnapshotServerOverHTTPService=ci([Tt(0,o.IConfigService),Tt(1,o.Inject(y.HTTPService))],_.SnapshotServerOverHTTPService);var hi=Object.defineProperty,li=Object.getOwnPropertyDescriptor,_i=(n,t,e,s)=>{for(var i=s>1?void 0:s?li(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&hi(t,e,i),i},oe=(n,t)=>(e,s)=>t(e,s,n);let Be=class extends o.LocalUndoRedoService{constructor(n,t,e,s,i){super(n,t,e),this._transformService=s,this._logService=i}transformUndoRedo(n,t){const e=this._getUndoStack(n);if(e)try{const i=this._transformStack(e,t);this._substituteUndoStack(n,i)}catch(i){this._logService.error("[CollaborationUndoRedoService]",i),this._clearUndo(n)}const s=this._getRedoStack(n);if(s)try{const i=this._transformStack(s,t);this._substituteRedoStack(n,i)}catch(i){this._logService.error(i),this._clearRedo(n)}}_clearUndo(n){const t=this._getUndoStack(n);t&&(t.length=0,this._updateStatus())}_clearRedo(n){const t=this._getRedoStack(n);t&&(t.length=0,this._updateStatus())}_substituteUndoStack(n,t){this._undoStacks.set(n,t),this._updateStatus()}_substituteRedoStack(n,t){this._redoStacks.set(n,t),this._updateStatus()}_transformStack(n,t){const e=[];let s=t,i=t;for(let r=n.length-1;r>=0;r--){const{unitID:a,undoMutations:c,redoMutations:h}=n[r],l=this._transformService.transformMutationsWithChangeset(s,c),S=this._transformService.transformMutationsWithChangeset(i,h);if(u.isTransformMutationsWithChangesetFailure(l)||u.isTransformMutationsWithChangesetFailure(S)){this._logService.error("[CollaborationUndoRedoService]","transformStack failed!",l,S);break}s=l.c1Prime,i=S.c1Prime,e.push({unitID:a,undoMutations:l.m2Prime,redoMutations:S.m2Prime})}return e.reverse()}};Be=_i([oe(0,o.IUniverInstanceService),oe(1,o.ICommandService),oe(2,o.IContextService),oe(3,u.ITransformService),oe(4,o.ILogService)],Be);class bt extends o.RxDisposable{constructor(){super();d(this,"urlChange$");this.urlChange$=f.fromEvent(window,"popstate").pipe(f.takeUntil(this.dispose$),f.shareReplay(1),f.mapTo(void 0))}setParam(e,s,i=!1){const r=new URL(window.location.href);r.searchParams.set(e,s),i?window.history.replaceState("","",r.toString()):window.history.pushState("","",r.toString())}removeParam(e,s=!1){const i=new URL(window.location.href);i.searchParams.delete(e),s?window.history.replaceState("","",i.toString()):window.history.pushState("","",i.toString())}getParam(e){var i;return(i=new URL(window.location.href).searchParams.get(e))!=null?i:void 0}}const Fe="collab-text-anchor-",ui="collab-text-range-",di="collab-rect-range-",ae=6,Si=1.5,Ve=4,vi=1.5,fi="rgba(255, 255, 255, 0.01)";class Rt{constructor(t,e,s,i){d(this,"_shapes",[]);d(this,"_anchor",null);d(this,"_textBubble",null);d(this,"_anchorDot",null);d(this,"_hideTimer",null);d(this,"_eventUnsubscribe",null);this._cursor=t,this._scene=e,this._docSkeleton=s,this._document=i,this._render()}set _hover(t){t?(this._anchorDot&&this._anchorDot.hide(),this._textBubble&&this._textBubble.show()):(this._anchorDot&&this._anchorDot.show(),this._textBubble&&this._textBubble.hide())}dispose(){for(const t of this._shapes)t.dispose();this._textBubble&&this._textBubble.dispose(),this._anchorDot&&this._anchorDot.dispose(),this._anchor&&this._anchor.dispose(),this._eventUnsubscribe&&this._eventUnsubscribe()}_render(){var S;const{_docSkeleton:t,_document:e}=this,{color:s,name:i,ranges:r}=this._cursor,a=e.getOffsetConfig(),{docsLeft:c,docsTop:h}=a,l=new b.NodePositionConvertToCursor(a,t);for(const{startOffset:v,endOffset:I,collapsed:g,isActive:T}of r){const D=t.findNodePositionByCharIndex(v),O=t.findNodePositionByCharIndex(I);if(T){const{contentBoxPointGroup:M}=l.getRangePointData(O,O);if(M.length===0)continue;this._drawAnchor(s,M,c,h,i),this._eventUnsubscribe=this._handleHover()}if(!g&&D&&O)if(b.isValidRectRange(D,O)){const M=new b.NodePositionConvertToRectRange(a,t),{pointGroup:q}=(S=M.getRangePointData(D,O))!=null?S:{};if(q==null||q.length===0)continue;this._drawRectRange(s,q,c,h)}else{const{contentBoxPointGroup:M}=l.getRangePointData(D,O);if(M.length===0)continue;this._drawTextRange(s,M,c,h)}}}_drawAnchor(t,e,s,i,r){const a=this._getAnchorBounding(e),{left:c,top:h,height:l}=a,S=this._getScale(),v=vi/S,I=new b.Rect(Fe+o.Tools.generateRandomId(ae),{left:c+s-v,top:h+i,height:l,width:Si,fill:t||b.getColor(o.COLORS.black,0),strokeWidth:v,stroke:fi,evented:!0});this._anchor=I,this._scene.addObject(I,b.TEXT_RANGE_LAYER_INDEX);const g=new b.Rect(Fe+o.Tools.generateRandomId(ae),{left:c+s-v,top:h+i-Ve/2,height:Ve,width:Ve,fill:t||b.getColor(o.COLORS.black,0),strokeWidth:0,stroke:t||b.getColor(o.COLORS.black,0),evented:!1});this._anchorDot=g,this._scene.addObject(g,b.TEXT_RANGE_LAYER_INDEX);const T=new me(Fe+o.Tools.generateRandomId(ae),{left:c+s-v,top:h+i-ne,text:r,color:t});this._textBubble=T,this._scene.addObject(T,b.TEXT_RANGE_LAYER_INDEX),this._hover=!1}_handleHover(){const t=this._anchor.onPointerEnter$.subscribeEvent(()=>{this._hover=!0}),e=this._anchor.onPointerLeave$.subscribeEvent(()=>{this._hideTimer&&clearTimeout(this._hideTimer),this._hideTimer=setTimeout(()=>{this._hover=!1},2e3)});return()=>{t.unsubscribe(),e.unsubscribe()}}_drawTextRange(t,e,s,i){const a=new o.ColorKit(t).setAlpha(.2).toRgbString(),c=new b.RegularPolygon(ui+o.Tools.generateRandomId(ae),{pointsGroup:e,fill:a||b.getColor(o.COLORS.black,.2),left:s,top:i,evented:!1,debounceParentDirty:!1});this._shapes.push(c),this._scene.addObject(c,b.TEXT_RANGE_LAYER_INDEX)}_drawRectRange(t,e,s,i){const a=new o.ColorKit(t).setAlpha(.2).toRgbString(),c=new b.RegularPolygon(di+o.Tools.generateRandomId(ae),{pointsGroup:e,fill:a||b.getColor(o.COLORS.black,.2),left:s,top:i,evented:!1,debounceParentDirty:!1});this._shapes.push(c),this._scene.addObject(c,b.TEXT_RANGE_LAYER_INDEX)}_getAnchorBounding(t){const e=t[0],s=e[0],i=e[2],{x:r,y:a}=s,{x:c,y:h}=i;return{left:r,top:a,width:c-r,height:h-a}}_getScale(){const{scaleX:t,scaleY:e}=this._scene.getAncestorScale();return Math.max(t,e)}}var mi=Object.defineProperty,Ii=Object.getOwnPropertyDescriptor,gi=(n,t,e,s)=>{for(var i=s>1?void 0:s?Ii(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&mi(t,e,i),i},pe=(n,t)=>(e,s)=>t(e,s,n);let Ee=class extends o.RxDisposable{constructor(t,e,s,i,r){super();d(this,"_cursorShapes",[]);d(this,"_cursors",[]);this._context=t,this._docSkeletonManagerService=e,this._collabCursorController=s,this._commandService=i,this._themeService=r,this._init()}_init(){const t=this._context.unitId,e=this._docSkeletonManagerService;this.disposeWithMe(f.combineLatest([this._collabCursorController.getCollabCursors$(t),this._themeService.currentTheme$]).pipe(C.map(([s,i])=>({skeleton:e.getSkeleton(),cursors:[...s.values()].flatMap(r=>({...r,color:i[r.color]}))}))).subscribe(s=>{if(this._removeCollabCursors(),s){const{skeleton:i,cursors:r}=s;this._updateCollabCursors(i,r)}})),this._initResize(),this._initCommandExecutedListener()}_updateCollabCursors(t,e){const{scene:s,mainComponent:i}=this._context,r=e.map(a=>new Rt(a,s,t,i));this._cursorShapes=r,this._cursors=e}_refreshCollabCursors(){this._removeCollabCursors();const{scene:t,mainComponent:e}=this._context,s=this._docSkeletonManagerService.getSkeleton(),i=this._cursors.map(r=>new Rt(r,t,s,e));this._cursorShapes=i}_removeCollabCursors(){this._cursorShapes.forEach(t=>t.dispose()),this._cursorShapes=[]}_initCommandExecutedListener(){const t=[U.SetDocZoomRatioOperation.id];this.disposeWithMe(this._commandService.onCommandExecuted(e=>{t.includes(e.id)&&e.params.unitId===this._context.unitId&&this._refreshCollabCursors()}))}_initResize(){this.disposeWithMe(o.fromEventSubject(this._context.engine.onTransformChange$).pipe(C.filter(t=>t.type===b.TRANSFORM_CHANGE_OBSERVABLE_TYPE.resize),C.throttleTime(16)).subscribe(()=>{this._refreshCollabCursors()}))}};Ee=gi([o.OnLifecycle(o.LifecycleStages.Steady,Ee),pe(1,o.Inject(U.DocSkeletonManagerService)),pe(2,o.Inject(Q)),pe(3,o.ICommandService),pe(4,o.Inject(o.ThemeService))],Ee);const Ot="ANONYMOUS_LOGIN_URL",pi="/universer-api/anonymous";function Ei(){function n(c){let h,l,S,v="";for(c+="",h=0,l=c.length;h<l;h++)S=c.charCodeAt(h).toString(16),v+=S.length<2?`0${S}`:S;return v}const t=window.document.createElement("canvas"),e=t.getContext("2d"),s=window.location.host;e&&(e.textBaseline="top",e.font="14px 'Arial'",e.textBaseline="tencent",e.fillStyle="#f60",e.fillRect(125,1,62,20),e.fillStyle="#069",e.fillText(s,2,15),e.fillStyle="rgba(102, 204, 0, 0.7)",e.fillText(s,4,17));const i=t.toDataURL().replace("data:image/png;base64,",""),r=atob(i);return n(r.slice(-16,-12))}var Ci=Object.defineProperty,Ti=Object.getOwnPropertyDescriptor,bi=(n,t,e,s)=>{for(var i=s>1?void 0:s?Ti(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Ci(t,e,i),i},Dt=(n,t)=>(e,s)=>t(e,s,n);let Ce=class{constructor(n,t){d(this,"deviceId","");this._configService=n,this._httpService=t,this.init()}init(){this._initDeviceId(),this._httpService.registerHTTPInterceptor({priority:1,interceptor:(n,t)=>(n.requestParams&&(n.requestParams.withCredentials=!0),t(n))}),this.anonymousLogin()}_initDeviceId(){try{this.deviceId=Ei()}catch{this.deviceId=""}}async anonymousLogin(){var n,t;if(!this.deviceId)throw new Error("deviceId is empty");try{const e=(n=this._configService.getConfig(Ot))!=null?n:pi;return((t=(await this._httpService.post(e,{body:{deviceID:this.deviceId},withCredentials:!0})).body)==null?void 0:t.user)||null}catch{return null}}};Ce=bi([Dt(0,o.Inject(o.IConfigService)),Dt(1,o.Inject(y.HTTPService))],Ce);var Ri=Object.defineProperty,Oi=Object.getOwnPropertyDescriptor,Di=(n,t,e,s)=>{for(var i=s>1?void 0:s?Oi(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Ri(t,e,i),i},Ut=(n,t)=>(e,s)=>t(e,s,n);const Pt="AUTHZ_URL_KEY",Ui="/universer-api/authz";_.AuthzIoHttpService=class extends o.Disposable{constructor(t,e){super(),this._HTTPService=t,this._configService=e,this._initMergeInterceptor()}_initMergeInterceptor(){const t=this;this.disposeWithMe(this._HTTPService.registerHTTPInterceptor({priority:999,interceptor:y.MergeInterceptorFactory({isMatch(e){var s;if(e.method==="POST"&&((s=e.requestParams)!=null&&s.body)){const{objectID:i,objectType:r}=e.requestParams.body||{};if(!i||r===void 0)return!1;const a=`${t._getAPIPrefixPath()}/${r}/object/${i}/allowed`;if(e.url===a)return!0}return!1},getParamsFromRequest(e){var i;return(i=e.requestParams)==null?void 0:i.body},mergeParamsToRequest(e,s){const i=`${t._getAPIPrefixPath()}/-/object/-/batch_allowed`,r=e.reduce((c,h)=>{const{unitID:l,objectID:S,objectType:v,actions:I}=h;return c[l]||(c[l]={}),c[l][S]||(c[l][S]={objectID:S,objectType:v,actions:[]}),c[l][S].actions.push(...I),c},{}),a=[];for(const c in r)for(const h in r[c]){const{actions:l,objectType:S}=r[c][h],v=[...new Set(l)];a.push({unitID:c,objectID:h,objectType:S,actions:v})}return new y.HTTPRequest("POST",i,{headers:s.headers,withCredentials:s.withCredentials,responseType:s.responseType,body:{requests:a}})}},{distributeResult(e,s){const{objectActions:i}=e;return s.map(r=>{const{unitID:a,objectID:c,actions:h}=r,l=i.find(v=>v.unitID===a&&v.objectID===c),S=h.map(v=>l==null?void 0:l.actions.find(I=>I.action===v)).filter(v=>!!v);return{config:r,result:{actions:S,error:e.error}}})}})}))}_getAPIPrefixPath(){var t;return(t=this._configService.getConfig(Pt))!=null?t:Ui}async create(t){const e=`${this._getAPIPrefixPath()}/${t.objectType}/object`;return(await this._HTTPService.post(e,{body:t})).body.objectID||""}async list(t){const e=`${this._getAPIPrefixPath()}/-/object/list`;return(await this._HTTPService.post(e,{body:t})).body.objects}async update(t){const e=`${this._getAPIPrefixPath()}/${t.objectType}/object/${t.objectID}`;await this._HTTPService.put(e,{body:t})}async allowed(t){const e=`${this._getAPIPrefixPath()}/${t.objectType}/object/${t.objectID}/allowed`;return(await this._HTTPService.post(e,{body:t})).body.actions}async batchAllowed(t){const e=`${this._getAPIPrefixPath()}/-/object/-/batch_allowed`;return(await this._HTTPService.post(e,{body:{requests:t}})).body.objectActions}async listRoles(t){const e=`${this._getAPIPrefixPath()}/${t.objectType}/role`,s=await this._HTTPService.post(e,{body:t});return{roles:s.body.roles,actions:s.body.actions}}async deleteCollaborator(t){const e=`${this._getAPIPrefixPath()}/collaborator`;await this._HTTPService.delete(e,{params:{collaboratorID:t.collaboratorID,objectID:t.objectID,unitID:t.unitID}})}async updateCollaborator(t){const e=`${this._getAPIPrefixPath()}/collaborator`;await this._HTTPService.patch(e,{body:t})}async createCollaborator(t){const e=`${this._getAPIPrefixPath()}/collaborator`;await this._HTTPService.post(e,{body:t})}async listCollaborators(t){const e=`${this._getAPIPrefixPath()}/collaborator`;return(await this._HTTPService.get(e,{params:{objectID:t.objectID,unitID:t.unitID}})).body.collaborators}async putCollaborators(t){const e=`${this._getAPIPrefixPath()}/collaborator`;await this._HTTPService.put(e,{body:t})}},_.AuthzIoHttpService=Di([Ut(0,o.Inject(y.HTTPService)),Ut(1,o.Inject(o.IConfigService))],_.AuthzIoHttpService);var Pi=Object.defineProperty,yi=Object.getOwnPropertyDescriptor,Ni=(n,t,e,s)=>{for(var i=s>1?void 0:s?yi(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Pi(t,e,i),i},yt=(n,t)=>(e,s)=>t(e,s,n);const Ai=["image/png","image/jpeg","image/jpg","image/gif","image/bmp"],Mi=5*1024*1024,Li="EXCHANGE_UPLOAD_FILE_SERVER_URL_KEY",wi="/universer-api/stream/file/upload",$i="EXCHANGE_SIGN_URL_SERVER_URL_KEY",ji="/universer-api/file/{fileID}/sign-url";_.ImageIoService=class{constructor(t,e){d(this,"_waitCount",0);d(this,"_change$",new f.Subject);d(this,"change$",this._change$);d(this,"_imageSourceCache",new Map);this._httpService=t,this._configService=e}setWaitCount(t){this._waitCount=t,this._change$.next(t)}getImageSourceCache(t,e){if(e===$.ImageSourceType.BASE64){const s=new Image;return s.src=t,s}return this._imageSourceCache.get(t)}addImageSourceCache(t,e,s){e===$.ImageSourceType.BASE64||s==null||this._imageSourceCache.set(t,s)}async getImage(t){try{const e=this._replaceFileID(this._getSignURL(),`${t}`),i=(await this._httpService.get(e)).body;return i.error&&i.error.code===et.OK?Promise.resolve(i.url):Promise.reject(i.error)}catch(e){return Promise.reject(e)}}async saveImage(t){let e="";if(!Ai.includes(t.type))return this._decreaseWaiting(),Promise.reject(new Error($.ImageUploadStatusType.ERROR_IMAGE_TYPE));if(t.size>Mi)return this._decreaseWaiting(),Promise.reject(new Error($.ImageUploadStatusType.ERROR_EXCEED_SIZE));try{const s=new FormData;s.append("file",t);const i=`${this._getUploadFileURL()}?size=${t.size.toString()}`,a=await(await fetch(i,{method:"POST",body:s})).json();if(typeof a.FileId!="string")return this._decreaseWaiting(),Promise.reject(new Error($.ImageUploadStatusType.ERROR_IMAGE));e=a.FileId}catch{return this._decreaseWaiting(),Promise.reject(new Error($.ImageUploadStatusType.ERROR_IMAGE))}return new Promise((s,i)=>{const r=new FileReader;r.readAsDataURL(t),r.onload=a=>{var l;const c=(l=a.target)==null?void 0:l.result;if(c==null){this._decreaseWaiting(),i(new Error($.ImageUploadStatusType.ERROR_IMAGE));return}const h=o.Tools.generateRandomId(6);s({imageId:h,imageSourceType:$.ImageSourceType.UUID,source:e,base64Cache:c,status:$.ImageUploadStatusType.SUCCUSS}),this._decreaseWaiting()}})}_getUploadFileURL(){var t;return(t=this._configService.getConfig(Li))!=null?t:wi}_getSignURL(){var t;return(t=this._configService.getConfig($i))!=null?t:ji}_replaceFileID(t,e){return t.replace("{fileID}",e)}_decreaseWaiting(){this._waitCount-=1,this._change$.next(this._waitCount)}},_.ImageIoService=Ni([yt(0,o.Inject(y.HTTPService)),yt(1,o.IConfigService)],_.ImageIoService);var Hi=Object.defineProperty,ki=Object.getOwnPropertyDescriptor,Bi=(n,t,e,s)=>{for(var i=s>1?void 0:s?ki(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Hi(t,e,i),i},ce=(n,t)=>(e,s)=>t(e,s,n);let Te=class extends o.RxDisposable{constructor(n,t,e,s,i){super(),this._injector=n,this._univerInstanceService=t,this._permissionService=e,this._collaborationSessionService=s,this._localeService=i,this._initUnitPermissionChange(),this._initCloseConn()}_initCloseConn(){const n=async t=>{(await this._collaborationSessionService.requireSession(t)).event$.pipe(C.filter(s=>s.eventID===u.CollaborationEvent.SHOULD_CLOSE_CONN),C.takeUntil(this.dispose$)).subscribe(s=>{const i=s,{reason:r}=i.data;this._injector.get(L.IMessageService).show({type:z.MessageType.Error,content:`${this._localeService.t("collaboration.closeRoom")}(${r})`}),this._permissionService.updatePermissionPoint(new p.WorkbookEditablePermission(t).id,!1),this._collaborationSessionService.closeSession(t)})};f.merge(this._univerInstanceService.getTypeOfUnitAdded$(o.UniverInstanceType.UNIVER_SHEET),this._univerInstanceService.getTypeOfUnitAdded$(o.UniverInstanceType.UNIVER_DOC)).pipe(C.map(t=>t.getUnitId()),C.filter(t=>!o.isInternalEditorID(t)),C.takeUntil(this.dispose$)).subscribe(t=>{n(t)})}_initUnitPermissionChange(){const n=async t=>{(await this._collaborationSessionService.requireSession(t)).event$.pipe(C.filter(s=>s.eventID===u.CollaborationEvent.UPDATE_PERMISSION_OBJ),C.takeUntil(this.dispose$)).subscribe(s=>{const i=s,{objectId:r}=i.data;r===t&&this._injector.get(J.SheetPermissionInitController).initWorkbookPermissionChange(t)})};f.merge(this._univerInstanceService.getTypeOfUnitAdded$(o.UniverInstanceType.UNIVER_SHEET),this._univerInstanceService.getTypeOfUnitAdded$(o.UniverInstanceType.UNIVER_DOC)).pipe(C.map(t=>t.getUnitId()),C.filter(t=>!o.isInternalEditorID(t)),C.takeUntil(this.dispose$)).subscribe(t=>{n(t)})}};Te=Bi([o.OnLifecycle(o.LifecycleStages.Starting,Te),ce(0,o.Inject(o.Injector)),ce(1,o.IUniverInstanceService),ce(2,o.IPermissionService),ce(3,o.Inject(_.CollaborationSessionService)),ce(4,o.Inject(o.LocaleService))],Te);var Nt=Object.defineProperty,Fi=Object.getOwnPropertyDescriptor,Vi=(n,t,e)=>t in n?Nt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Wi=(n,t,e,s)=>{for(var i=s>1?void 0:s?Fi(t,e):t,r=n.length-1,a;r>=0;r--)(a=n[r])&&(i=(s?a(t,e,i):a(i))||i);return s&&i&&Nt(t,e,i),i},We=(n,t)=>(e,s)=>t(e,s,n),Gi=(n,t,e)=>Vi(n,t+"",e);const Yi="UNIVER_COLLABORATION_CLIENT_PLUGIN";_.UniverCollaborationClientPlugin=class extends o.Plugin{constructor(t,e,s,i){super(),this._config=t,this._logService=e,this._renderManagerService=s,this._injector=i}onStarting(t){this._registerDependencies(t)}onRendered(){this._registerRenderDependencies()}_registerDependencies(t){var s,i,r,a;t.has(o.IUndoRedoService)&&this._logService.error("[UniverCollaborationClientPlugin]",'you should override "IUndoRedoService" provided in "core" package!');let e=[[o.IUndoRedoService,{useClass:Be}],[_.CollaborationSessionService],[Ne],[y.HTTPService],[ke,{useClass:bt}],[G],[_.LocalCacheService],[y.WebSocketService],[Se],[de],[ue],[Pe],[Ce],[Ue],[Te],[De,{useClass:(i=(s=this._config)==null?void 0:s.socketService)!=null?i:_.CollaborationSocketService}],[y.IHTTPImplementation,{useClass:y.XHRHTTPImplementation}],[o.ISnapshotServerService,{useClass:_.SnapshotServerOverHTTPService}],[o.IAuthzIoService,{useClass:_.AuthzIoHttpService}],[$.IImageIoService,{useClass:_.ImageIoService}],[_.CollaborationController],[_.DataLoaderController],[_.DesktopCollaborationStatusDisplayController],[ge],[Q]];(r=this._config)!=null&&r.enableSingleActiveInstanceLock&&e.push([_e,{useClass:Qt}]),e=o.mergeOverrideWithDependencies(e,(a=this._config)==null?void 0:a.override),e.forEach(c=>t.add(c)),this._initModules()}_registerRenderDependencies(){this.disposeWithMe(this._renderManagerService.registerRenderModule(o.UniverInstanceType.UNIVER_DOC,[Ee])),this.disposeWithMe(this._renderManagerService.registerRenderModule(o.UniverInstanceType.UNIVER_SHEET,[je]))}_initModules(){var e,s;this._injector.get(y.HTTPService).registerHTTPInterceptor({priority:20,interceptor:y.ThresholdInterceptorFactory({maxParallel:6})}),(e=this._config)!=null&&e.enableOfflineEditing||this._injector.get(_.LocalCacheService).disableLocalCache(),(s=this._config)!=null&&s.enableAuthServer&&this._injector.get(Ce)}},Gi(_.UniverCollaborationClientPlugin,"pluginName",Yi),_.UniverCollaborationClientPlugin=Wi([o.DependentOn(u.UniverCollaborationPlugin),We(1,o.ILogService),We(2,b.IRenderManagerService),We(3,o.Inject(o.Injector))],_.UniverCollaborationClientPlugin),_.ANONYMOUS_LOGIN_URL=Ot,_.AUTHZ_URL_KEY=Pt,_.COLLAB_SUBMIT_CHANGESET_URL_KEY=Qe,_.COLLAB_WEB_SOCKET_URL_KEY=ze,_.CollaborationStatus=P,_.CollaborationStatusDisplay=Et,_.CommentService=Ue,_.HEARTBEAT_INTERVAL_KEY=Je,_.HEARTBEAT_TIMEOUT_KEY=Re,_.ICollaborationSocketService=De,_.IURLService=ke,_.LOCAL_CACHE_INTERVAL_KEY=Ze,_.LOGIN_URL_KEY=kt,_.SEND_CHANGESET_TIMEOUT_KEY=qe,_.SNAPSHOT_SERVER_URL_KEY=Ke,_.SNAPSHOT_URL_KEY=Xe,_.SessionStatus=Y,_.SheetCollabCursorShape=mt,_.WebURLService=bt,_.deserializeToCombResponse=st,_.serializeCombRequest=it,Object.defineProperty(_,Symbol.toStringTag,{value:"Module"})});
